<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <title>Your Sacred Journey | Mirror of Truth</title>
    <link rel="stylesheet" href="/shared/foundation.css" />

    <style>
      /* Dashboard - Sacred Journey Command Center */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        background: linear-gradient(
          135deg,
          #0f0f23 0%,
          #1a1a2e 25%,
          #16213e 50%,
          #0f0f23 100%
        );
        color: #fff;
        font-family: Inter, -apple-system, BlinkMacSystemFont, sans-serif;
        min-height: 100vh;
        overflow-x: hidden;
        -webkit-text-size-adjust: 100%;
        -ms-text-size-adjust: 100%;
        touch-action: manipulation;
      }

      /* Cosmic Background Animation */
      .cosmic-background {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 1;
        overflow: hidden;
      }

      .cosmic-breath {
        position: absolute;
        border-radius: 50%;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.04) 0%,
          rgba(255, 255, 255, 0.015) 40%,
          rgba(255, 255, 255, 0.008) 70%,
          transparent 100%
        );
        animation: cosmicBreathe 18s ease-in-out infinite;
        opacity: 0;
      }

      .cosmic-breath:nth-child(1) {
        width: clamp(200px, 40vw, 300px);
        height: clamp(200px, 40vw, 300px);
        left: 15%;
        top: 10%;
        animation-delay: 0s;
        animation-duration: 20s;
      }

      .cosmic-breath:nth-child(2) {
        width: clamp(150px, 30vw, 200px);
        height: clamp(150px, 30vw, 200px);
        right: 20%;
        top: 60%;
        animation-delay: 5s;
        animation-duration: 16s;
      }

      .cosmic-breath:nth-child(3) {
        width: clamp(100px, 25vw, 150px);
        height: clamp(100px, 25vw, 150px);
        left: 60%;
        top: 30%;
        animation-delay: 10s;
        animation-duration: 22s;
      }

      .cosmic-breath:nth-child(4) {
        width: clamp(180px, 35vw, 250px);
        height: clamp(180px, 35vw, 250px);
        left: 30%;
        bottom: 20%;
        animation-delay: 15s;
        animation-duration: 18s;
      }

      @keyframes cosmicBreathe {
        0% {
          opacity: 0;
          transform: scale(0.8);
        }
        25% {
          opacity: 0.3;
          transform: scale(1);
        }
        50% {
          opacity: 0.5;
          transform: scale(1.2);
        }
        75% {
          opacity: 0.2;
          transform: scale(1.4);
        }
        100% {
          opacity: 0;
          transform: scale(1.8);
        }
      }

      /* Navigation */
      .dashboard-nav {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 100;
        background: rgba(15, 15, 35, 0.9);
        backdrop-filter: blur(25px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding: 0;
      }

      .nav-container {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 2rem;
        gap: 1rem;
      }

      .nav-left {
        display: flex;
        align-items: center;
        flex-shrink: 0;
      }

      .logo-link {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        text-decoration: none;
        color: rgba(255, 255, 255, 0.95);
        font-weight: 500;
        font-size: clamp(1rem, 2.5vw, 1.1rem);
        transition: all 0.3s ease;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }

      .mirror-symbol {
        font-size: clamp(1.5rem, 4vw, 1.8rem);
        animation: gentleGlow 4s ease-in-out infinite;
      }

      @keyframes gentleGlow {
        0%,
        100% {
          opacity: 0.8;
          transform: scale(1);
        }
        50% {
          opacity: 1;
          transform: scale(1.05);
        }
      }

      .logo-text {
        font-weight: 300;
        letter-spacing: 0.5px;
      }

      .nav-center {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
        justify-content: center;
      }

      .nav-link {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.8rem 1.2rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 50px;
        color: rgba(255, 255, 255, 0.7);
        text-decoration: none;
        font-size: clamp(0.8rem, 2vw, 0.9rem);
        font-weight: 400;
        transition: all 0.3s ease;
        white-space: nowrap;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        min-height: 44px;
      }

      .nav-link:hover,
      .nav-link.active {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.95);
        transform: translateY(-1px);
      }

      .nav-link:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
      }

      .nav-right {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-shrink: 0;
      }

      .upgrade-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.8rem 1.2rem;
        background: linear-gradient(135deg, #f59e0b, #d97706);
        border: none;
        border-radius: 50px;
        color: white;
        font-size: clamp(0.8rem, 2vw, 0.9rem);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        white-space: nowrap;
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        min-height: 44px;
      }

      .upgrade-btn:hover {
        background: linear-gradient(135deg, #d97706, #b45309);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
      }

      /* User Menu */
      .user-menu {
        position: relative;
      }

      .user-button {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        padding: 0.8rem 1.2rem;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 50px;
        color: rgba(255, 255, 255, 0.9);
        cursor: pointer;
        font-size: clamp(0.8rem, 2vw, 0.9rem);
        transition: all 0.3s ease;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        min-height: 44px;
      }

      .user-button:hover {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.25);
      }

      .user-avatar {
        font-size: 1.2rem;
      }

      .user-name {
        font-weight: 400;
        max-width: 120px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .dropdown-arrow {
        font-size: 0.7rem;
        opacity: 0.7;
        transition: transform 0.3s ease;
      }

      .user-menu.open .dropdown-arrow {
        transform: rotate(180deg);
      }

      .user-dropdown {
        position: absolute;
        top: calc(100% + 0.5rem);
        right: 0;
        min-width: 280px;
        background: rgba(15, 15, 35, 0.95);
        backdrop-filter: blur(30px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
        z-index: 200;
      }

      .user-dropdown.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .dropdown-header {
        padding: 1.5rem 1.2rem 1rem;
      }

      .user-info {
        text-align: center;
      }

      .user-display-name {
        font-size: 1.1rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.95);
        margin-bottom: 0.5rem;
      }

      .user-tier-badge {
        font-size: 0.8rem;
        padding: 0.3rem 0.8rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50px;
        color: rgba(255, 255, 255, 0.8);
        display: inline-block;
      }

      .user-tier-badge.essential {
        background: rgba(16, 185, 129, 0.2);
        color: #6ee7b7;
      }

      .user-tier-badge.premium {
        background: rgba(245, 158, 11, 0.2);
        color: #fbbf24;
      }

      .user-tier-badge.creator {
        background: linear-gradient(
          135deg,
          rgba(147, 51, 234, 0.3),
          rgba(99, 102, 241, 0.2)
        );
        color: #c4b5fd;
      }

      .dropdown-divider {
        height: 1px;
        background: rgba(255, 255, 255, 0.1);
        margin: 0.5rem 0;
      }

      .dropdown-item {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        padding: 0.8rem 1.2rem;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        border: none;
        background: none;
        cursor: pointer;
        width: 100%;
        text-align: left;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        min-height: 44px;
      }

      .dropdown-item:hover {
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.95);
      }

      /* Main Dashboard */
      .dashboard-main {
        position: relative;
        z-index: 10;
        min-height: 100vh;
        padding-top: 80px;
      }

      .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
      }

      /* Welcome Section */
      .welcome-section {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 3rem;
        padding: 2rem;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.05) 0%,
          rgba(255, 255, 255, 0.02) 100%
        );
        backdrop-filter: blur(30px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 24px;
        position: relative;
        overflow: hidden;
        animation: fadeInUp 1s ease-out;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .welcome-content {
        flex: 1;
      }

      .welcome-title {
        font-size: clamp(1.8rem, 5vw, 2.5rem);
        font-weight: 300;
        margin-bottom: 0.5rem;
        line-height: 1.3;
      }

      .greeting {
        color: rgba(255, 255, 255, 0.7);
        display: block;
        font-size: clamp(1rem, 3vw, 1.2rem);
        margin-bottom: 0.3rem;
      }

      .user-name-display {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.95) 0%,
          rgba(255, 255, 255, 0.8) 100%
        );
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        display: block;
      }

      .welcome-subtitle {
        font-size: clamp(0.9rem, 2.5vw, 1rem);
        color: rgba(255, 255, 255, 0.6);
        margin: 0;
        font-weight: 300;
        line-height: 1.5;
      }

      .quick-actions {
        display: flex;
        gap: 1rem;
        flex-shrink: 0;
      }

      .action-btn {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        padding: 1rem 1.5rem;
        border: none;
        border-radius: 16px;
        font-size: clamp(0.9rem, 2.5vw, 1rem);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        white-space: nowrap;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        min-height: 48px;
      }

      .action-btn.primary {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.15),
          rgba(255, 255, 255, 0.08)
        );
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
      }

      .action-btn.secondary {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.12);
        color: rgba(255, 255, 255, 0.8);
      }

      .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(255, 255, 255, 0.1);
      }

      .action-btn.primary:hover {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.2),
          rgba(255, 255, 255, 0.12)
        );
        border-color: rgba(255, 255, 255, 0.3);
      }

      .action-btn:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
      }

      /* Dashboard Grid */
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      /* Dashboard Cards */
      .dashboard-card {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.06) 0%,
          rgba(255, 255, 255, 0.02) 100%
        );
        backdrop-filter: blur(40px);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 20px;
        padding: 1.5rem;
        position: relative;
        overflow: hidden;
        transition: all 0.4s ease;
        animation: cardAppear 0.8s ease-out forwards;
        animation-delay: var(--delay, 0s);
      }

      .dashboard-card:nth-child(1) {
        --delay: 0.1s;
      }
      .dashboard-card:nth-child(2) {
        --delay: 0.2s;
      }
      .dashboard-card:nth-child(3) {
        --delay: 0.3s;
      }
      .dashboard-card:nth-child(4) {
        --delay: 0.4s;
      }

      @keyframes cardAppear {
        from {
          opacity: 0;
          transform: translateY(30px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .dashboard-card::before {
        content: "";
        position: absolute;
        inset: 1px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.08) 0%,
          rgba(255, 255, 255, 0.02) 100%
        );
        border-radius: 19px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .dashboard-card:hover::before {
        opacity: 1;
      }

      .dashboard-card:hover {
        border-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(255, 255, 255, 0.05);
      }

      .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
        position: relative;
        z-index: 2;
      }

      .card-title {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        font-size: clamp(1.1rem, 3vw, 1.3rem);
        font-weight: 500;
        color: rgba(255, 255, 255, 0.95);
        margin: 0;
      }

      .card-icon {
        font-size: 1.5rem;
        opacity: 0.9;
      }

      .header-action {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 20px;
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.3s ease;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        min-height: 36px;
        text-decoration: none;
      }

      .header-action:hover {
        background: rgba(255, 255, 255, 0.12);
        color: rgba(255, 255, 255, 0.9);
      }

      .card-content {
        position: relative;
        z-index: 2;
      }

      /* Usage Card */
      .usage-display {
        display: flex;
        align-items: center;
        gap: 2rem;
        margin-bottom: 1.5rem;
      }

      .usage-chart {
        flex-shrink: 0;
      }

      .progress-circle {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: conic-gradient(
          from 0deg,
          rgba(16, 185, 129, 0.8) 0%,
          rgba(16, 185, 129, 0.8) var(--progress, 0%),
          rgba(255, 255, 255, 0.1) var(--progress, 0%),
          rgba(255, 255, 255, 0.1) 100%
        );
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        animation: progressSpin 2s ease-out;
      }

      @keyframes progressSpin {
        from {
          transform: rotate(-90deg);
        }
        to {
          transform: rotate(0deg);
        }
      }

      .progress-circle::before {
        content: "";
        width: 75px;
        height: 75px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          rgba(15, 15, 35, 0.95) 0%,
          rgba(26, 26, 46, 0.95) 100%
        );
        position: absolute;
      }

      .progress-value {
        font-size: 1.2rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.9);
        position: relative;
        z-index: 1;
      }

      .usage-stats {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex: 1;
      }

      .stat-item {
        text-align: center;
      }

      .stat-value {
        font-size: clamp(1.5rem, 4vw, 2rem);
        font-weight: 600;
        color: rgba(255, 255, 255, 0.95);
        line-height: 1;
      }

      .stat-label {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.6);
        margin-top: 0.3rem;
      }

      .stat-divider {
        color: rgba(255, 255, 255, 0.4);
        font-size: 1.2rem;
        font-weight: 300;
      }

      .usage-actions {
        text-align: center;
      }

      .usage-btn {
        padding: 0.8rem 1.5rem;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        min-height: 44px;
        text-decoration: none;
        display: inline-block;
      }

      .usage-btn:hover {
        background: rgba(255, 255, 255, 0.12);
        color: rgba(255, 255, 255, 0.95);
        transform: translateY(-1px);
      }

      /* Reflections Card */
      .reflections-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        max-height: 300px;
        overflow-y: auto;
        padding-right: 0.5rem;
      }

      .reflection-item {
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        animation: reflectionSlide 0.5s ease-out;
      }

      @keyframes reflectionSlide {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .reflection-item:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.15);
        transform: translateX(5px);
      }

      .reflection-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
      }

      .reflection-title {
        font-size: 0.95rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.9);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
        margin-right: 1rem;
      }

      .reflection-date {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.5);
      }

      .reflection-preview {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.7);
        line-height: 1.4;
        margin-bottom: 0.8rem;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
      }

      .reflection-meta {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .reflection-tone {
        font-size: 0.75rem;
        padding: 0.2rem 0.6rem;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.8);
      }

      .reflection-tone.fusion {
        background: rgba(251, 191, 36, 0.2);
        color: #fbbf24;
      }

      .reflection-tone.gentle {
        background: rgba(255, 255, 255, 0.15);
        color: rgba(255, 255, 255, 0.9);
      }

      .reflection-tone.intense {
        background: rgba(147, 51, 234, 0.2);
        color: #c4b5fd;
      }

      .premium-indicator {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        font-weight: 500;
      }

      /* Loading States */
      .loading-reflections {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
        padding: 2rem;
        color: rgba(255, 255, 255, 0.6);
      }

      .cosmic-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        border-top-color: rgba(255, 255, 255, 0.8);
        animation: spin 1.5s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Empty States */
      .empty-state {
        text-align: center;
        padding: 2rem 1rem;
        color: rgba(255, 255, 255, 0.7);
      }

      .empty-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.8;
      }

      .empty-state h4 {
        font-size: 1.2rem;
        font-weight: 500;
        margin: 0 0 0.5rem 0;
        color: rgba(255, 255, 255, 0.9);
      }

      .empty-state p {
        font-size: 0.9rem;
        margin: 0 0 1.5rem 0;
        line-height: 1.5;
      }

      .empty-action {
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.8rem 1.5rem;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.12),
          rgba(255, 255, 255, 0.06)
        );
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        min-height: 44px;
        text-decoration: none;
      }

      .empty-action:hover {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.18),
          rgba(255, 255, 255, 0.1)
        );
        transform: translateY(-2px);
      }

      /* Evolution Card */
      .evolution-preview {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .insight-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.8rem;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        transition: all 0.3s ease;
      }

      .insight-item.locked {
        opacity: 0.6;
      }

      .insight-icon {
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        flex-shrink: 0;
      }

      .insight-text {
        flex: 1;
      }

      .insight-title {
        font-size: 0.9rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 0.2rem;
      }

      .insight-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.95);
      }

      .unlock-message {
        font-size: 0.8rem !important;
        font-weight: 400 !important;
        color: rgba(255, 255, 255, 0.6) !important;
        font-style: italic;
      }

      .required-count {
        color: rgba(16, 185, 129, 0.8);
        font-weight: 500;
      }

      .evolution-badge {
        padding: 0.3rem 0.8rem;
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        font-size: 0.7rem;
        font-weight: 600;
        border-radius: 20px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        animation: badgePulse 2s ease-in-out infinite;
      }

      @keyframes badgePulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .evolution-actions {
        text-align: center;
      }

      .evolution-btn {
        padding: 0.8rem 1.5rem;
        background: linear-gradient(
          135deg,
          rgba(16, 185, 129, 0.2),
          rgba(16, 185, 129, 0.1)
        );
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: 12px;
        color: #6ee7b7;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        min-height: 44px;
        text-decoration: none;
        display: inline-block;
      }

      .evolution-btn:hover {
        background: linear-gradient(
          135deg,
          rgba(16, 185, 129, 0.3),
          rgba(16, 185, 129, 0.15)
        );
        transform: translateY(-2px);
      }

      /* Subscription Card */
      .tier-display {
        margin-bottom: 1.5rem;
      }

      .tier-badge {
        display: inline-block;
        padding: 0.6rem 1.2rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .tier-badge.free {
        background: rgba(255, 255, 255, 0.15);
        color: rgba(255, 255, 255, 0.9);
      }

      .tier-badge.essential {
        background: linear-gradient(
          135deg,
          rgba(16, 185, 129, 0.3),
          rgba(16, 185, 129, 0.2)
        );
        color: #6ee7b7;
      }

      .tier-badge.premium {
        background: linear-gradient(
          135deg,
          rgba(245, 158, 11, 0.3),
          rgba(245, 158, 11, 0.2)
        );
        color: #fbbf24;
      }

      .tier-badge.creator {
        background: linear-gradient(
          135deg,
          rgba(147, 51, 234, 0.3),
          rgba(99, 102, 241, 0.2)
        );
        color: #c4b5fd;
      }

      .tier-description {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
        line-height: 1.5;
      }

      .subscription-actions {
        text-align: center;
      }

      .subscription-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
        padding: 1rem 1.5rem;
        border: none;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        min-height: 44px;
      }

      .subscription-btn.upgrade-subscription {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
      }

      .subscription-btn.upgrade-subscription:hover {
        background: linear-gradient(135deg, #d97706, #b45309);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
      }

      /* Loading Overlay */
      .loading-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .loading-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .loading-content {
        text-align: center;
        color: rgba(255, 255, 255, 0.9);
      }

      .cosmic-loader {
        width: 60px;
        height: 60px;
        border: 3px solid rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1.5s linear infinite;
        margin: 0 auto 1rem;
      }

      .loading-content p {
        font-size: 1rem;
        opacity: 0.8;
      }

      /* Toast Notifications */
      .toast-container {
        position: fixed;
        top: 100px;
        right: 1rem;
        z-index: 1001;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        max-width: 400px;
      }

      .toast {
        padding: 1rem 1.5rem;
        background: rgba(15, 15, 35, 0.95);
        backdrop-filter: blur(30px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        color: rgba(255, 255, 255, 0.9);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        transform: translateX(100%);
        opacity: 0;
        transition: all 0.3s ease;
        animation: toastSlideIn 0.3s ease-out forwards;
      }

      @keyframes toastSlideIn {
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .toast.success {
        border-color: rgba(16, 185, 129, 0.3);
        background: linear-gradient(
          135deg,
          rgba(15, 15, 35, 0.95) 0%,
          rgba(16, 185, 129, 0.1) 100%
        );
      }

      .toast.error {
        border-color: rgba(239, 68, 68, 0.3);
        background: linear-gradient(
          135deg,
          rgba(15, 15, 35, 0.95) 0%,
          rgba(239, 68, 68, 0.1) 100%
        );
      }

      .toast.warning {
        border-color: rgba(245, 158, 11, 0.3);
        background: linear-gradient(
          135deg,
          rgba(15, 15, 35, 0.95) 0%,
          rgba(245, 158, 11, 0.1) 100%
        );
      }

      /* Mobile Responsive */
      @media (max-width: 1024px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        body {
          padding-top: 70px;
        }

        .nav-container {
          padding: 0.8rem 1rem;
          flex-wrap: wrap;
          gap: 0.5rem;
        }

        .nav-center {
          order: 3;
          width: 100%;
          justify-content: center;
          margin-top: 0.5rem;
        }

        .nav-link {
          padding: 0.6rem 1rem;
          font-size: 0.8rem;
        }

        .logo-text {
          display: none;
        }

        .user-name {
          display: none;
        }

        .dashboard-container {
          padding: 1rem;
        }

        .welcome-section {
          flex-direction: column;
          gap: 1.5rem;
          text-align: center;
          padding: 1.5rem;
        }

        .quick-actions {
          flex-direction: column;
          width: 100%;
        }

        .action-btn {
          width: 100%;
          justify-content: center;
        }

        .dashboard-grid {
          gap: 1rem;
          margin-bottom: 1rem;
        }

        .dashboard-card {
          padding: 1.2rem;
        }

        .usage-display {
          flex-direction: column;
          gap: 1rem;
          text-align: center;
        }

        .usage-stats {
          justify-content: center;
        }

        .user-dropdown {
          min-width: 260px;
          right: -1rem;
        }

        .toast-container {
          right: 0.5rem;
          left: 0.5rem;
          max-width: none;
        }
      }

      @media (max-width: 480px) {
        .nav-container {
          padding: 0.6rem 0.8rem;
        }

        .nav-center {
          gap: 0.3rem;
        }

        .nav-link {
          padding: 0.5rem 0.8rem;
          font-size: 0.75rem;
        }

        .nav-link span:last-child {
          display: none;
        }

        .upgrade-btn span:last-child {
          display: none;
        }

        .dashboard-container {
          padding: 0.8rem;
        }

        .welcome-section {
          padding: 1.2rem;
          margin-bottom: 1.5rem;
        }

        .welcome-title {
          font-size: 1.5rem;
        }

        .dashboard-card {
          padding: 1rem;
          border-radius: 16px;
        }

        .card-title {
          font-size: 1.1rem;
        }

        .insight-item {
          padding: 0.6rem;
        }

        .reflection-item {
          padding: 0.8rem;
        }

        .user-dropdown {
          min-width: 240px;
        }
      }

      /* Accessibility */
      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }

        .cosmic-breath,
        .cosmic-spinner,
        .progress-circle {
          animation: none;
        }
      }

      /* iOS specific optimizations */
      @supports (-webkit-touch-callout: none) {
        .dashboard-nav {
          padding-top: max(0px, env(safe-area-inset-top));
        }

        .dashboard-container {
          padding-left: max(1rem, env(safe-area-inset-left));
          padding-right: max(1rem, env(safe-area-inset-right));
        }

        .toast-container {
          right: max(1rem, env(safe-area-inset-right));
        }
      }
    </style>
  </head>

  <body>
    <!-- Cosmic Background -->
    <div class="cosmic-background">
      <div class="cosmic-breath"></div>
      <div class="cosmic-breath"></div>
      <div class="cosmic-breath"></div>
      <div class="cosmic-breath"></div>
    </div>

    <!-- Navigation Header -->
    <nav class="dashboard-nav">
      <div class="nav-container">
        <div class="nav-left">
          <a href="/" class="logo-link">
            <span class="mirror-symbol">ü™û</span>
            <span class="logo-text">Mirror of Truth</span>
          </a>
        </div>

        <div class="nav-center">
          <a href="/dashboard" class="nav-link active">
            <span>üè†</span>
            <span>My Journey</span>
          </a>
          <a href="/reflection" class="nav-link reflect-nav">
            <span>‚ú®</span>
            <span>Reflect Again</span>
          </a>
          <a href="/admin" class="nav-link admin-only" style="display: none">
            <span>‚ö°</span>
            <span>Admin</span>
          </a>
        </div>

        <div class="nav-right">
          <a
            href="/register"
            class="upgrade-btn tier-upgrade"
            style="display: none"
          >
            <span>üíé</span>
            <span>Upgrade</span>
          </a>

          <div class="user-menu">
            <button class="user-button" id="userMenuBtn">
              <span class="user-avatar" id="userAvatar">üë§</span>
              <span class="user-name" id="userName">Loading...</span>
              <span class="dropdown-arrow">‚ñº</span>
            </button>

            <div class="user-dropdown" id="userDropdown">
              <div class="dropdown-header">
                <div class="user-info">
                  <div class="user-display-name" id="userDisplayName">
                    Loading...
                  </div>
                  <div class="user-tier-badge" id="userTierBadge">...</div>
                </div>
              </div>

              <div class="dropdown-divider"></div>

              <a href="/profile" class="dropdown-item">
                <span>üë§</span>
                <span>Profile Settings</span>
              </a>
              <a href="/subscription" class="dropdown-item subscription-only">
                <span>üí≥</span>
                <span>Subscription</span>
              </a>
              <a
                href="/evolution"
                class="dropdown-item evolution-only"
                style="display: none"
              >
                <span>üìä</span>
                <span>Evolution Reports</span>
              </a>

              <div class="dropdown-divider"></div>

              <button
                class="dropdown-item signout-btn"
                onclick="handleSignOut()"
              >
                <span>üö™</span>
                <span>Sign Out</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Dashboard -->
    <main class="dashboard-main">
      <div class="dashboard-container">
        <!-- Welcome Section -->
        <section class="welcome-section">
          <div class="welcome-content">
            <h1 class="welcome-title">
              <span class="greeting" id="welcomeGreeting">Welcome back,</span>
              <span class="user-name-display" id="welcomeName"
                >Sacred Soul</span
              >
            </h1>
            <p class="welcome-subtitle" id="welcomeMessage">
              Your journey of self-discovery continues...
            </p>
          </div>

          <div class="quick-actions">
            <a href="/reflection" class="action-btn primary" id="reflectNowBtn">
              <span class="btn-icon">‚ú®</span>
              <span class="btn-text">Reflect Now</span>
            </a>
            <a href="/gifting" class="action-btn secondary" id="giftBtn">
              <span class="btn-icon">üéÅ</span>
              <span class="btn-text">Gift a Reflection</span>
            </a>
          </div>
        </section>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
          <!-- Usage Overview Card -->
          <div class="dashboard-card usage-card">
            <div class="card-header">
              <h3 class="card-title">
                <span class="card-icon">üìä</span>
                <span>This Month's Journey</span>
              </h3>
            </div>

            <div class="card-content">
              <div class="usage-display">
                <div class="usage-chart" id="usageChart">
                  <div class="usage-progress">
                    <div class="progress-circle">
                      <div class="progress-value" id="usagePercentage">0%</div>
                    </div>
                  </div>
                </div>

                <div class="usage-stats">
                  <div class="stat-item">
                    <div class="stat-value" id="currentCount">0</div>
                    <div class="stat-label">Reflections Used</div>
                  </div>
                  <div class="stat-divider">of</div>
                  <div class="stat-item">
                    <div class="stat-value" id="monthlyLimit">‚àû</div>
                    <div class="stat-label">Monthly Limit</div>
                  </div>
                </div>
              </div>

              <div class="usage-actions">
                <a href="/reflections" class="usage-btn" id="usageActionBtn">
                  <span>View All Reflections</span>
                </a>
              </div>
            </div>
          </div>

          <!-- Recent Reflections Card -->
          <div class="dashboard-card reflections-card">
            <div class="card-header">
              <h3 class="card-title">
                <span class="card-icon">üåô</span>
                <span>Recent Reflections</span>
              </h3>
              <a
                href="/reflections"
                class="header-action"
                id="viewAllReflections"
              >
                <span>View All</span>
                <span>‚Üí</span>
              </a>
            </div>

            <div class="card-content">
              <div class="reflections-list" id="recentReflectionsList">
                <div class="loading-reflections">
                  <div class="cosmic-spinner"></div>
                  <span>Loading your sacred journey...</span>
                </div>
              </div>

              <div
                class="empty-state"
                id="emptyReflections"
                style="display: none"
              >
                <div class="empty-icon">ü™û</div>
                <h4>Your Journey Awaits</h4>
                <p>
                  Begin your first reflection to see your evolving wisdom here.
                </p>
                <a href="/reflection" class="empty-action">
                  <span>‚ú®</span>
                  <span>Create Your First Reflection</span>
                </a>
              </div>
            </div>
          </div>

          <!-- Evolution Insights Card -->
          <div class="dashboard-card evolution-card">
            <div class="card-header">
              <h3 class="card-title">
                <span class="card-icon">ü¶ã</span>
                <span>Evolution Insights</span>
              </h3>
              <div
                class="evolution-badge"
                id="evolutionBadge"
                style="display: none"
              >
                <span>New!</span>
              </div>
            </div>

            <div class="card-content">
              <div class="evolution-content" id="evolutionContent">
                <div class="evolution-preview">
                  <div class="insight-item">
                    <div class="insight-icon">üìà</div>
                    <div class="insight-text">
                      <div class="insight-title">Total Reflections</div>
                      <div class="insight-value" id="totalReflections">0</div>
                    </div>
                  </div>

                  <div class="insight-item locked" id="growthInsight">
                    <div class="insight-icon">üå±</div>
                    <div class="insight-text">
                      <div class="insight-title">Growth Patterns</div>
                      <div class="insight-value unlock-message">
                        Unlock with
                        <span class="required-count">3</span> reflections
                      </div>
                    </div>
                  </div>

                  <div class="insight-item locked" id="evolutionInsight">
                    <div class="insight-icon">ü¶ã</div>
                    <div class="insight-text">
                      <div class="insight-title">Evolution Report</div>
                      <div class="insight-value unlock-message">
                        Available for Essential+ subscribers
                      </div>
                    </div>
                  </div>
                </div>

                <div class="evolution-actions">
                  <a
                    href="/register"
                    class="evolution-btn"
                    id="evolutionActionBtn"
                  >
                    <span>Upgrade for Evolution Reports</span>
                  </a>
                </div>
              </div>
            </div>
          </div>

          <!-- Subscription Status Card -->
          <div class="dashboard-card subscription-card">
            <div class="card-header">
              <h3 class="card-title">
                <span class="card-icon">üíé</span>
                <span>Subscription</span>
              </h3>
            </div>

            <div class="card-content">
              <div class="subscription-status" id="subscriptionStatus">
                <div class="tier-display">
                  <div class="tier-badge" id="tierBadge">Free</div>
                  <div class="tier-description" id="tierDescription">
                    Limited to 1 reflection per month
                  </div>
                </div>

                <div class="subscription-actions">
                  <a
                    href="/register"
                    class="subscription-btn upgrade-subscription"
                    id="subscriptionActionBtn"
                  >
                    <span>‚ú®</span>
                    <span>Upgrade Your Journey</span>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-content">
        <div class="cosmic-loader"></div>
        <p>Preparing your sacred space...</p>
      </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
      // Dashboard Logic - Sacred Journey Command Center
      let userData = null;
      let usageData = null;
      let recentReflections = [];
      let isLoading = false;

      // Tier limits and evolution thresholds
      const TIER_LIMITS = {
        free: 1,
        essential: 5,
        premium: 10,
        creator: "unlimited",
      };

      const EVOLUTION_THRESHOLDS = {
        essential: 4,
        premium: 6,
      };

      // Initialize dashboard on page load
      window.addEventListener("load", initializeDashboard);

      async function initializeDashboard() {
        try {
          await authenticateAndLoadUser();
          await loadDashboardData();
          setupInteractions();
          animateEntry();
        } catch (error) {
          console.error("ü™û Dashboard initialization failed:", error);
          handleAuthenticationError();
        }
      }

      // Authentication & User Data
      async function authenticateAndLoadUser() {
        const token = localStorage.getItem("mirror_auth_token");

        if (!token) {
          throw new Error("No authentication token found");
        }

        try {
          const response = await fetch("/api/auth", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ action: "verify-token" }),
          });

          if (!response.ok) {
            throw new Error(`Authentication failed: ${response.status}`);
          }

          const data = await response.json();

          if (!data.success) {
            throw new Error(data.error || "Token verification failed");
          }

          userData = data.user;

          // Update localStorage with fresh data
          const updatedUserData = {
            name: userData.name,
            email: userData.email,
            language: userData.language || "en",
            isCreator: userData.isCreator || false,
            isAdmin: userData.isAdmin || false,
            tier: userData.tier || "free",
            subscriptionStatus: userData.subscriptionStatus || "active",
            reflectionCountThisMonth: userData.reflectionCountThisMonth || 0,
            totalReflections: userData.totalReflections || 0,
          };

          localStorage.setItem(
            "mirrorVerifiedUser",
            JSON.stringify(updatedUserData)
          );

          console.log(
            `ü™û Dashboard loaded for: ${userData.email} (${userData.tier})`
          );

          updateUserInterface();
        } catch (error) {
          console.error("ü™û Authentication error:", error);
          throw error;
        }
      }

      function updateUserInterface() {
        updateNavigation();
        updateWelcomeSection();
        updateUserMenu();
        updateTierSpecificElements();
      }

      function updateNavigation() {
        // Show admin link for creators/admins
        if (userData.isCreator || userData.isAdmin) {
          document.querySelector(".admin-only").style.display = "flex";
        }

        // Show upgrade button for free users
        if (userData.tier === "free") {
          document.querySelector(".tier-upgrade").style.display = "flex";
        }

        // Update reflection link with appropriate mode
        const reflectLink = document.querySelector(".reflect-nav");
        if (userData.isCreator) {
          reflectLink.href = "/reflection?mode=creator";
        } else {
          reflectLink.href = "/reflection";
        }
      }

      function updateWelcomeSection() {
        const greeting = getTimeBasedGreeting();
        const firstName = userData.name.split(" ")[0];

        document.getElementById("welcomeGreeting").textContent = greeting;
        document.getElementById("welcomeName").textContent = firstName;

        // Update welcome message based on tier and usage
        const welcomeMessage = getWelcomeMessage();
        document.getElementById("welcomeMessage").textContent = welcomeMessage;
      }

      function updateUserMenu() {
        const userName = document.getElementById("userName");
        const userDisplayName = document.getElementById("userDisplayName");
        const userTierBadge = document.getElementById("userTierBadge");
        const userAvatar = document.getElementById("userAvatar");

        // Update display name (first name only for UI)
        const firstName = userData.name.split(" ")[0];
        userName.textContent = firstName;
        userDisplayName.textContent = userData.name;

        // Update tier badge
        userTierBadge.textContent =
          userData.tier.charAt(0).toUpperCase() + userData.tier.slice(1);
        userTierBadge.className = `user-tier-badge ${userData.tier}`;

        // Update avatar based on tier
        if (userData.isCreator) {
          userAvatar.textContent = "üåü";
        } else if (userData.tier === "premium") {
          userAvatar.textContent = "üíé";
        } else if (userData.tier === "essential") {
          userAvatar.textContent = "‚ú®";
        } else {
          userAvatar.textContent = "üë§";
        }

        // Show/hide tier-specific menu items
        if (userData.tier === "free") {
          document
            .querySelectorAll(".evolution-only")
            .forEach((el) => (el.style.display = "none"));
        } else {
          document
            .querySelectorAll(".evolution-only")
            .forEach((el) => (el.style.display = "flex"));
        }
      }

      function updateTierSpecificElements() {
        updateSubscriptionCard();
        updateEvolutionCard();
      }

      // Dashboard Data Loading
      async function loadDashboardData() {
        showLoadingState(true);

        try {
          await loadUsageData();
          await loadRecentReflections();
          updateUsageDisplay();
          updateReflectionsDisplay();
          updateEvolutionDisplay();
        } catch (error) {
          console.error("ü™û Failed to load dashboard data:", error);
          showToast(
            "Failed to load dashboard data. Please refresh the page.",
            "error"
          );
        } finally {
          showLoadingState(false);
        }
      }

      async function loadUsageData() {
        try {
          const token = localStorage.getItem("mirror_auth_token");

          const response = await fetch("/api/reflections", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ action: "check-usage" }),
          });

          if (response.ok) {
            const data = await response.json();
            if (data.success) {
              usageData = data.usage;
            }
          }
        } catch (error) {
          console.error("ü™û Failed to load usage data:", error);
          // Use fallback data from userData
          usageData = {
            currentCount: userData.reflectionCountThisMonth,
            limit: userData.isCreator
              ? "unlimited"
              : TIER_LIMITS[userData.tier],
            canReflect: true,
            tier: userData.tier,
            totalReflections: userData.totalReflections,
            percentUsed: 0,
          };
        }
      }

      async function loadRecentReflections() {
        try {
          const token = localStorage.getItem("mirror_auth_token");

          // Use GET request with query parameters
          const url = new URL("/api/reflections", window.location.origin);
          url.searchParams.set("action", "get-history");
          url.searchParams.set("limit", "5");

          const reflectionsResponse = await fetch(url, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (reflectionsResponse.ok) {
            const data = await reflectionsResponse.json();
            if (data.success) {
              recentReflections = data.reflections || [];
            }
          }
        } catch (error) {
          console.error("ü™û Failed to load recent reflections:", error);
          recentReflections = [];
        }
      }

      // Display Updates
      function updateUsageDisplay() {
        const currentCount =
          usageData?.currentCount || userData.reflectionCountThisMonth;
        const limit =
          usageData?.limit ||
          (userData.isCreator ? "unlimited" : TIER_LIMITS[userData.tier]);

        // Update usage numbers
        document.getElementById("currentCount").textContent = currentCount;
        document.getElementById("monthlyLimit").textContent =
          limit === "unlimited" ? "‚àû" : limit;

        // Update progress circle
        let percentage = 0;
        if (limit !== "unlimited" && limit > 0) {
          percentage = Math.min((currentCount / limit) * 100, 100);
        }

        document.getElementById("usagePercentage").textContent = `${Math.round(
          percentage
        )}%`;

        // Update CSS custom property for progress circle
        const progressCircle = document.querySelector(".progress-circle");
        if (progressCircle) {
          progressCircle.style.setProperty("--progress", `${percentage}%`);
        }

        // Update usage action button
        const usageActionBtn = document.getElementById("usageActionBtn");
        if (currentCount === 0) {
          usageActionBtn.textContent = "Create Your First Reflection";
          usageActionBtn.href = "/reflection";
        } else {
          usageActionBtn.textContent = "View All Reflections";
          usageActionBtn.href = "/reflections";
        }
      }

      function updateReflectionsDisplay() {
        const reflectionsList = document.getElementById(
          "recentReflectionsList"
        );
        const emptyState = document.getElementById("emptyReflections");

        if (recentReflections.length === 0) {
          reflectionsList.style.display = "none";
          emptyState.style.display = "block";
        } else {
          reflectionsList.style.display = "block";
          emptyState.style.display = "none";

          // Clear loading state
          reflectionsList.innerHTML = "";

          // Add reflections
          recentReflections.forEach((reflection, index) => {
            const reflectionElement = createReflectionElement(reflection);
            reflectionElement.style.animationDelay = `${index * 0.1}s`;
            reflectionsList.appendChild(reflectionElement);
          });
        }
      }

      function createReflectionElement(reflection) {
        const element = document.createElement("div");
        element.className = "reflection-item";
        element.onclick = () => viewReflection(reflection.id);

        const timeAgo =
          reflection.timeAgo || formatTimeAgo(reflection.createdAt);
        const preview = reflection.dream
          ? reflection.dream.substring(0, 120)
          : "Reflection content...";

        element.innerHTML = `
          <div class="reflection-header">
            <div class="reflection-title">${
              reflection.title || "Sacred Reflection"
            }</div>
            <div class="reflection-date">${timeAgo}</div>
          </div>
          <div class="reflection-preview">${preview}${
          preview.length > 120 ? "..." : ""
        }</div>
          <div class="reflection-meta">
            <div class="reflection-tone ${
              reflection.tone || "fusion"
            }">${formatToneName(reflection.tone)}</div>
            ${
              reflection.isPremium
                ? '<div class="premium-indicator">Premium</div>'
                : ""
            }
          </div>
        `;

        return element;
      }

      function updateEvolutionDisplay() {
        const totalReflections = userData.totalReflections || 0;
        const evolutionActionBtn =
          document.getElementById("evolutionActionBtn");

        // Update total reflections
        document.getElementById("totalReflections").textContent =
          totalReflections;

        // Check evolution eligibility
        const canGenerateReport =
          userData.tier !== "free" &&
          totalReflections >= EVOLUTION_THRESHOLDS[userData.tier];

        // Update growth insight
        const growthInsight = document.getElementById("growthInsight");
        if (totalReflections >= 3) {
          growthInsight.classList.remove("locked");
          growthInsight.querySelector(".insight-value").textContent =
            "Available";
          growthInsight.querySelector(".insight-value").className =
            "insight-value";
        } else {
          const needed = 3 - totalReflections;
          growthInsight.querySelector(".required-count").textContent = needed;
        }

        // Update evolution insight
        const evolutionInsight = document.getElementById("evolutionInsight");
        if (userData.tier === "free") {
          evolutionInsight.querySelector(".insight-value").textContent =
            "Upgrade to Essential";
        } else if (canGenerateReport) {
          evolutionInsight.classList.remove("locked");
          evolutionInsight.querySelector(".insight-value").textContent =
            "Ready to Generate";
          evolutionInsight.querySelector(".insight-value").className =
            "insight-value";

          // Show new badge if eligible
          document.getElementById("evolutionBadge").style.display = "block";
        } else {
          const needed = EVOLUTION_THRESHOLDS[userData.tier] - totalReflections;
          evolutionInsight.querySelector(
            ".insight-value"
          ).textContent = `${needed} more reflection${
            needed === 1 ? "" : "s"
          } needed`;
        }

        // Update action button
        if (userData.tier === "free") {
          evolutionActionBtn.textContent = "Upgrade for Evolution Reports";
          evolutionActionBtn.href = "/register";
        } else if (canGenerateReport) {
          evolutionActionBtn.textContent = "Generate Evolution Report";
          evolutionActionBtn.className = "evolution-btn ready";
          evolutionActionBtn.onclick = generateEvolutionReport;
        } else {
          evolutionActionBtn.textContent = `Create ${
            EVOLUTION_THRESHOLDS[userData.tier] - totalReflections
          } more reflection${
            EVOLUTION_THRESHOLDS[userData.tier] - totalReflections === 1
              ? ""
              : "s"
          }`;
          evolutionActionBtn.href = "/reflection";
        }
      }

      function updateSubscriptionCard() {
        const tierBadge = document.getElementById("tierBadge");
        const tierDescription = document.getElementById("tierDescription");
        const subscriptionActionBtn = document.getElementById(
          "subscriptionActionBtn"
        );

        // Update tier display
        tierBadge.textContent =
          userData.tier.charAt(0).toUpperCase() + userData.tier.slice(1);
        tierBadge.className = `tier-badge ${userData.tier}`;

        // Update description based on tier
        const descriptions = {
          free: "Limited to 1 reflection per month",
          essential: "Up to 5 reflections per month + Evolution Reports",
          premium:
            "Up to 10 reflections per month + Advanced Evolution Insights",
          creator: "Unlimited reflections and full access to all features",
        };

        tierDescription.textContent =
          descriptions[userData.tier] || descriptions.free;

        // Update action button
        if (userData.tier === "free") {
          subscriptionActionBtn.innerHTML =
            "<span>‚ú®</span><span>Upgrade Your Journey</span>";
          subscriptionActionBtn.href = "/register";
        } else if (userData.tier === "essential") {
          subscriptionActionBtn.innerHTML =
            "<span>üíé</span><span>Upgrade to Premium</span>";
          subscriptionActionBtn.href = "/register?tier=premium";
        } else {
          subscriptionActionBtn.innerHTML =
            "<span>‚öôÔ∏è</span><span>Manage Subscription</span>";
          subscriptionActionBtn.href = "/subscription";
        }
      }

      // Interaction Handlers
      function setupInteractions() {
        setupUserMenu();

        // Quick action buttons
        document.getElementById("reflectNowBtn").href = userData.isCreator
          ? "/reflection?mode=creator"
          : "/reflection";

        // Mobile touch interactions
        if ("ontouchstart" in window) {
          addTouchInteractions();
        }

        // Keyboard navigation
        setupKeyboardNavigation();
      }

      function setupUserMenu() {
        const userMenuBtn = document.getElementById("userMenuBtn");
        const userDropdown = document.getElementById("userDropdown");
        const userMenu = document.querySelector(".user-menu");

        userMenuBtn.addEventListener("click", function (e) {
          e.stopPropagation();
          userMenu.classList.toggle("open");
          userDropdown.classList.toggle("show");
        });

        // Close menu when clicking outside
        document.addEventListener("click", function (e) {
          if (!userMenu.contains(e.target)) {
            userMenu.classList.remove("open");
            userDropdown.classList.remove("show");
          }
        });

        // Close menu on escape key
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            userMenu.classList.remove("open");
            userDropdown.classList.remove("show");
          }
        });
      }

      // Action Functions
      function viewReflection(reflectionId) {
        window.location.href = `/reflections/view?id=${reflectionId}`;
      }

      async function generateEvolutionReport() {
        if (isLoading) return;

        setLoadingState(true, "Generating your evolution report...");

        try {
          const token = localStorage.getItem("mirror_auth_token");

          const response = await fetch("/api/evolution", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ action: "generate-report" }),
          });

          const data = await response.json();

          if (data.success) {
            showToast("Evolution report generated successfully!", "success");
            setTimeout(() => {
              window.location.href = `/evolution?report=${data.report.id}`;
            }, 1500);
          } else {
            throw new Error(
              data.error || "Failed to generate evolution report"
            );
          }
        } catch (error) {
          console.error("ü™û Evolution report error:", error);
          showToast(
            "Failed to generate evolution report. Please try again.",
            "error"
          );
        } finally {
          setLoadingState(false);
        }
      }

      async function handleSignOut() {
        if (confirm("Are you sure you want to sign out?")) {
          try {
            const token = localStorage.getItem("mirror_auth_token");

            // Call signout API
            await fetch("/api/auth", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ action: "signout" }),
            });
          } catch (error) {
            console.error("ü™û Signout error:", error);
          } finally {
            // Clear local storage
            localStorage.removeItem("mirror_auth_token");
            localStorage.removeItem("mirrorVerifiedUser");

            // Redirect to portal
            window.location.href = "/";
          }
        }
      }

      // Utility Functions
      function getTimeBasedGreeting() {
        const hour = new Date().getHours();

        if (hour < 6) return "Deep night greetings,";
        if (hour < 12) return "Good morning,";
        if (hour < 17) return "Good afternoon,";
        if (hour < 21) return "Good evening,";
        return "Late night wisdom,";
      }

      function getWelcomeMessage() {
        const messages = {
          free: "Your journey of self-discovery awaits...",
          essential: "Continue exploring your inner landscape...",
          premium: "Dive deeper into your consciousness evolution...",
          creator: "Welcome to your sacred creative space...",
        };

        return messages[userData.tier] || messages.free;
      }

      function formatTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / (1000 * 60));
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        if (diffMins < 1) return "just now";
        if (diffMins < 60)
          return `${diffMins} min${diffMins === 1 ? "" : "s"} ago`;
        if (diffHours < 24)
          return `${diffHours} hour${diffHours === 1 ? "" : "s"} ago`;
        if (diffDays < 7)
          return `${diffDays} day${diffDays === 1 ? "" : "s"} ago`;

        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
          year: diffDays > 365 ? "numeric" : undefined,
        });
      }

      function formatToneName(tone) {
        const toneNames = {
          gentle: "Gentle",
          intense: "Intense",
          fusion: "Fusion",
        };
        return toneNames[tone] || "Fusion";
      }

      // Loading & Error States
      function showLoadingState(show, message = "Loading...") {
        const overlay = document.getElementById("loadingOverlay");
        const loadingText = overlay.querySelector("p");

        if (show) {
          loadingText.textContent = message;
          overlay.style.display = "flex";
          requestAnimationFrame(() => overlay.classList.add("show"));
        } else {
          overlay.classList.remove("show");
          setTimeout(() => (overlay.style.display = "none"), 300);
        }
      }

      function setLoadingState(loading, message = null) {
        isLoading = loading;
        if (message) {
          showLoadingState(loading, message);
        }
      }

      function handleAuthenticationError() {
        showToast("Authentication failed. Please sign in again.", "error");

        setTimeout(() => {
          localStorage.removeItem("mirror_auth_token");
          localStorage.removeItem("mirrorVerifiedUser");
          window.location.href = "/auth/signin";
        }, 2000);
      }

      // Toast Notifications
      function showToast(message, type = "info", duration = 5000) {
        const container = document.getElementById("toastContainer");

        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;

        container.appendChild(toast);

        // Remove toast after duration
        setTimeout(() => {
          toast.style.transform = "translateX(100%)";
          toast.style.opacity = "0";

          setTimeout(() => {
            if (container.contains(toast)) {
              container.removeChild(toast);
            }
          }, 300);
        }, duration);
      }

      // Mobile Interactions
      function addTouchInteractions() {
        document
          .querySelectorAll(".dashboard-card, .action-btn, .nav-link")
          .forEach((element) => {
            element.addEventListener("touchstart", function () {
              this.style.transform = "scale(0.98)";
            });

            element.addEventListener("touchend", function () {
              this.style.transform = "";
            });
          });
      }

      function setupKeyboardNavigation() {
        document.addEventListener("keydown", function (e) {
          // Cmd/Ctrl + R for new reflection
          if ((e.metaKey || e.ctrlKey) && e.key === "r") {
            e.preventDefault();
            window.location.href = userData.isCreator
              ? "/reflection?mode=creator"
              : "/reflection";
          }

          // Cmd/Ctrl + G for gift
          if ((e.metaKey || e.ctrlKey) && e.key === "g") {
            e.preventDefault();
            window.location.href = "/gifting";
          }
        });
      }

      // Animations
      function animateEntry() {
        // Stagger card animations
        const cards = document.querySelectorAll(".dashboard-card");
        cards.forEach((card, index) => {
          card.style.animationDelay = `${0.1 + index * 0.1}s`;
        });

        // Animate progress circle
        setTimeout(() => {
          const progressCircle = document.querySelector(".progress-circle");
          if (progressCircle) {
            progressCircle.style.animation = "progressSpin 2s ease-out";
          }
        }, 500);
      }

      // Debug (Development Only)
      if (window.location.hostname === "localhost") {
        console.log("ü™û Sacred Dashboard initialized");

        window.dashboardDebug = {
          userData: () => userData,
          usageData: () => usageData,
          recentReflections: () => recentReflections,
          refreshData: loadDashboardData,
          testToast: (message, type) => showToast(message, type),
        };
      }
    </script>
  </body>
</html>
