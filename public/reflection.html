<!-- FILE: public/reflection.html â€¢ access-code first, verify-flow fixed â€¢ 2025-06-01 -->
<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Your Reflection | ×”×”×©×ª×§×¤×•×ª ×©×œ×š</title>

    <!--â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  INLINE STYLES  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-->
    <style>
      /*â”€â”€ reset & base â”€â”€*/
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(
          135deg,
          #0f0f23 0%,
          #1a1a2e 25%,
          #16213e 50%,
          #0f0f23 100%
        );
        min-height: 100vh;
        color: #fff;
        overflow-x: hidden;
      }
      [dir="rtl"] {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      /*â”€â”€ layout wrapper â”€â”€*/
      .container {
        max-width: 700px;
        margin: 0 auto;
        padding: 2rem;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .experience-section {
        width: 100%;
        text-align: center;
        opacity: 0;
        transform: translateY(30px);
        transition: 0.8s ease;
      }
      .experience-section.active {
        opacity: 1;
        transform: translateY(0);
      }
      .experience-section.hidden {
        display: none;
      }

      /*â”€â”€ access-code â”€â”€*/
      .access-code-text {
        font-size: 1.1rem;
        font-weight: 300;
        opacity: 0.9;
        line-height: 1.6;
        margin-bottom: 2rem;
      }
      .code-input-container {
        max-width: 300px;
        margin: 2rem auto;
      }
      .code-input {
        width: 100%;
        padding: 1.2rem;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        color: #fff;
        font-size: 1.5rem;
        text-align: center;
        letter-spacing: 0.3em;
        font-family: "Courier New", monospace;
        font-weight: 600;
        transition: 0.3s;
      }
      .code-input:focus {
        outline: none;
        border-color: rgba(255, 255, 255, 0.4);
        background: rgba(255, 255, 255, 0.12);
      }
      .code-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
        letter-spacing: 0.2em;
      }
      .continue-btn {
        width: 100%;
        padding: 1.2rem 2rem;
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        color: #fff;
        font-size: 1rem;
        cursor: pointer;
        transition: 0.3s;
        margin-top: 3rem;
      }
      .continue-btn:hover {
        background: rgba(255, 255, 255, 0.25);
        border-color: rgba(255, 255, 255, 0.5);
      }
      .continue-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .error-message {
        background: rgba(239, 68, 68, 0.2);
        border: 1px solid rgba(239, 68, 68, 0.4);
        color: #fecaca;
        padding: 1rem;
        border-radius: 12px;
        margin-top: 1rem;
        text-align: center;
        font-size: 0.9rem;
      }

      /*â”€â”€ question form â”€â”€*/
      .questions-form {
        text-align: left;
      }
      [dir="rtl"] .questions-form {
        text-align: right;
      }
      .question-group {
        margin-bottom: 3rem;
        opacity: 0;
        transform: translateY(20px);
        transition: 0.6s ease;
      }
      .question-group.visible {
        opacity: 1;
        transform: translateY(0);
      }
      .question-number {
        font-size: 0.9rem;
        opacity: 0.6;
        margin-bottom: 0.5rem;
      }
      .question-text {
        font-size: 1.2rem;
        font-weight: 400;
        margin-bottom: 1rem;
        line-height: 1.4;
      }
      .question-subtitle {
        font-size: 0.9rem;
        opacity: 0.7;
        margin-bottom: 1rem;
        font-style: italic;
      }
      .question-input,
      .question-textarea {
        width: 100%;
        padding: 1.2rem;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        color: #fff;
        font-size: 1rem;
        line-height: 1.5;
        transition: 0.3s;
        font-family: inherit;
      }
      .question-textarea {
        min-height: 120px;
        resize: vertical;
      }
      .question-input:focus,
      .question-textarea:focus {
        outline: none;
        border-color: rgba(255, 255, 255, 0.4);
        background: rgba(255, 255, 255, 0.12);
      }
      .question-input::placeholder,
      .question-textarea::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }
      .date-container {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-top: 1rem;
      }
      [dir="rtl"] .date-container {
        flex-direction: row-reverse;
      }
      .yes-no-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 0.5rem;
      }
      .yes-no-btn {
        flex: 1;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        color: #fff;
        cursor: pointer;
        transition: 0.3s;
        text-align: center;
      }
      .yes-no-btn:hover,
      .yes-no-btn.selected {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.4);
      }

      /*â”€â”€ loading â”€â”€*/
      .loading-screen {
        text-align: center;
      }
      .loading-circle {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.2) 0%,
          rgba(255, 255, 255, 0.05) 70%
        );
        margin: 0 auto 2rem;
        animation: pulse 2s ease-in-out infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 0.7;
        }
        50% {
          transform: scale(1.05);
          opacity: 1;
        }
      }
      .loading-text {
        font-size: 1.1rem;
        font-weight: 300;
        opacity: 0.8;
      }

      /*â”€â”€ results â”€â”€*/
      .results {
        text-align: left;
      }
      [dir="rtl"] .results {
        text-align: right;
      }
      .results-content {
        background: rgba(255, 255, 255, 0.95);
        color: #333;
        padding: 3rem;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        margin-bottom: 2rem;
        line-height: 1.8;
        font-size: 1.05rem;
      }
      .results-content h1,
      .results-content h2,
      .results-content h3 {
        color: #1a1a2e;
        margin-bottom: 1rem;
        font-weight: 500;
      }
      .results-content strong {
        color: #16213e;
        font-weight: 600;
      }
      .results-content em {
        color: #666;
        font-style: italic;
      }
      .results-content p {
        margin-bottom: 1.5rem;
      }
      .results-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
      }
      .action-btn {
        padding: 1rem 2rem;
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        color: #fff;
        text-decoration: none;
        cursor: pointer;
        transition: 0.3s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
      }
      .action-btn:hover {
        background: rgba(255, 255, 255, 0.25);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-2px);
      }
      .admin-notice {
        background: rgba(59, 130, 246, 0.2);
        border: 1px solid rgba(59, 130, 246, 0.4);
        padding: 1rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        text-align: center;
        font-size: 0.9rem;
      }

      /*â”€â”€ media â”€â”€*/
      @media (max-width: 768px) {
        .container {
          padding: 1rem;
        }
        .access-code-text {
          font-size: 1rem;
        }
        .question-text {
          font-size: 1.1rem;
        }
        .results-content {
          padding: 2rem;
        }
        .results-actions {
          flex-direction: column;
        }
        .date-container {
          flex-direction: column;
          align-items: stretch;
        }
        [dir="rtl"] .date-container {
          flex-direction: column;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- 1ï¸âƒ£ Access-code (initial screen) -->
      <div class="experience-section active" id="accessCode">
        <div class="access-code-section">
          <div class="access-code-text" id="accessCodeText">
            Please enter your verification code from the email
          </div>
          <div class="code-input-container">
            <input
              type="text"
              id="codeInput"
              class="code-input"
              maxlength="6"
              placeholder="000000"
            />
          </div>
          <button
            class="continue-btn"
            id="verifyCodeBtn"
            onclick="verifyAccessCode()"
          >
            Verify Code
          </button>
          <div
            class="error-message"
            id="errorMessage"
            style="display: none"
          ></div>
        </div>
      </div>

      <!-- 2ï¸âƒ£ Questions -->
      <div class="experience-section hidden" id="questions">
        <div class="questions-form">
          <form id="reflectionForm">
            <!-- Question 1 -->
            <div class="question-group">
              <div class="question-number" id="q1Number">Question 1</div>
              <div class="question-text" id="q1Text">What is your dream?</div>
              <div class="question-subtitle" id="q1Subtitle">
                (Choose just one â€” the one that calls you most right now.)
              </div>
              <textarea
                class="question-textarea"
                name="dream"
                id="dreamInput"
                required
              ></textarea>
            </div>

            <!-- Question 2 -->
            <div class="question-group">
              <div class="question-number" id="q2Number">Question 2</div>
              <div class="question-text" id="q2Text">
                What is your plan for achieving this dream?
              </div>
              <div class="question-subtitle" id="q2Subtitle">
                (Write what you already know. It's okay if it's unclear.)
              </div>
              <textarea
                class="question-textarea"
                name="plan"
                id="planInput"
                required
              ></textarea>
            </div>

            <!-- Question 3 -->
            <div class="question-group">
              <div class="question-number" id="q3Number">Question 3</div>
              <div class="question-text" id="q3Text">
                Have you set a definite date for fulfilling your dream?
              </div>
              <div class="yes-no-buttons">
                <div class="yes-no-btn" data-value="yes" id="yesBtn">Yes</div>
                <div class="yes-no-btn" data-value="no" id="noBtn">No</div>
              </div>
              <input type="hidden" name="hasDate" required />
              <div
                class="date-container"
                id="dateContainer"
                style="display: none"
              >
                <label style="opacity: 0.8" id="dateLabel"
                  >What is the date?</label
                >
                <input type="date" class="question-input" name="dreamDate" />
              </div>
            </div>

            <!-- Question 4 -->
            <div class="question-group">
              <div class="question-number" id="q4Number">Question 4</div>
              <div class="question-text" id="q4Text">
                What is your current relationship with this dream?
              </div>
              <div class="question-subtitle" id="q4Subtitle">
                (Do you believe you'll achieve it? Why or why not?)
              </div>
              <textarea
                class="question-textarea"
                name="relationship"
                id="relationshipInput"
                required
              ></textarea>
            </div>

            <!-- Question 5 -->
            <div class="question-group">
              <div class="question-number" id="q5Number">Question 5</div>
              <div class="question-text" id="q5Text">
                What are you willing to give in return?
              </div>
              <div class="question-subtitle" id="q5Subtitle">
                (Energy, focus, love, time â€” what will you offer to this dream?)
              </div>
              <textarea
                class="question-textarea"
                name="offering"
                id="offeringInput"
                required
              ></textarea>
            </div>

            <button type="submit" class="continue-btn" id="submitBtn">
              Receive Your Reflection
            </button>
          </form>
        </div>
      </div>

      <!-- 3ï¸âƒ£ Loading -->
      <div class="experience-section hidden" id="loading">
        <div class="loading-screen">
          <div class="loading-circle"></div>
          <div class="loading-text" id="loadingText">
            Reflecting your truthâ€¦
          </div>
        </div>
      </div>

      <!-- 4ï¸âƒ£ Results -->
      <div class="experience-section hidden" id="results">
        <div class="results">
          <div class="admin-notice" id="adminNotice" style="display: none">
            âœ¨ Admin session â€” unlimited reflections
          </div>
          <div class="results-content" id="reflectionContent"></div>
          <div class="results-actions">
            <button
              class="action-btn"
              id="emailBtn"
              onclick="emailReflection()"
            >
              ğŸ“§ <span id="emailText">Email This Reflection</span>
            </button>
            <a href="/" class="action-btn" id="reflectAgainBtn">
              ğŸª <span id="reflectAgainText">Reflect Again</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <!--â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  SCRIPT  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-->
    <script>
      /*â”€â”€ state & language â”€â”€*/
      let currentLanguage =
        new URLSearchParams(location.search).get("lang") ||
        localStorage.getItem("mirrorLanguage") ||
        "en";
      let userData = null,
        hasDateSet = null,
        isAdminMode = false;

      /* translations */
      const translations = {
        en: {
          accessCodeText: "Please enter your verification code from the email",
          verifyCodeBtn: "Verify Code",
          invalidCode: "Invalid or expired code â€” try again",
          codePlaceholder: "000000",
          loadingText: "Reflecting your truthâ€¦",
          dreamPlaceholder: "Write the dream that calls you",
          planPlaceholder: "Describe any plan you have (or none)",
          relationshipPlaceholder:
            "How do you feel about this dream right now?",
          offeringPlaceholder: "What energy will you give in return?",
          emailText: "Email This Reflection",
          reflectAgainText: "Reflect Again",
          adminNoticeText: "âœ¨ Admin session â€” unlimited reflections",
        },
        he: {
          accessCodeText: "×× × ×”×›× ×¡ ××ª ×§×•×“ ×”××™××•×ª ×©× ×©×œ×— ×‘××™×™×œ",
          verifyCodeBtn: "×××ª ×§×•×“",
          invalidCode: "×§×•×“ ×œ× ×ª×§×£ ××• ×©×¤×’ ×ª×•×§×¤×• â€” × ×¡×” ×©×•×‘",
          codePlaceholder: "000000",
          loadingText: "××©×§×£ ××ª ×”×××ª ×©×œ×šâ€¦",
          dreamPlaceholder: "×›×ª×•×‘ ××ª ×”×—×œ×•× ×©×§×•×¨× ×œ×š",
          planPlaceholder: "×ª××¨ ×›×œ ×ª×›× ×™×ª (××• ×”×¢×“×¨ ×ª×›× ×™×ª)",
          relationshipPlaceholder: "××™×š ××ª×” ××¨×’×™×© ×›×œ×¤×™ ×”×—×œ×•× ×¢×›×©×™×•?",
          offeringPlaceholder: "××™×–×• ×× ×¨×’×™×” ××ª×” ××•×›×Ÿ ×œ×ª×ª ×‘×ª××•×¨×”?",
          emailText: "×©×œ×— ××ª ×”×”×©×ª×§×¤×•×ª ×‘××™×™×œ",
          reflectAgainText: "×”×©×ª×§×£ ×©×•×‘",
          adminNoticeText: "âœ¨ ×¡×©×Ÿ ×× ×”×œ â€” ×”×©×ª×§×¤×•×™×•×ª ×œ×œ× ×”×’×‘×œ×”",
        },
      };

      document.addEventListener("DOMContentLoaded", () => {
        applyLanguage();
        initFlow();
      });

      function applyLanguage() {
        const t = translations[currentLanguage];
        const html = document.documentElement;
        html.dir = currentLanguage === "he" ? "rtl" : "ltr";
        html.lang = currentLanguage;
        Object.entries(t).forEach(([k, v]) => {
          const e = document.getElementById(k);
          if (e) e.textContent = v;
        });
        /* placeholders */
        codeInput.placeholder = t.codePlaceholder;
        dreamInput.placeholder = t.dreamPlaceholder;
        planInput.placeholder = t.planPlaceholder;
        relationshipInput.placeholder = t.relationshipPlaceholder;
        offeringInput.placeholder = t.offeringPlaceholder;
        loadingText.textContent = t.loadingText;
      }

      /* flow decision */
      function initFlow() {
        const url = new URLSearchParams(location.search);
        const payment = url.get("payment");
        const verified = url.get("verified") === "true";

        if (url.get("admin") === "true") {
          isAdminMode = true;
          adminNotice.style.display = "block";
          startQuestions();
          return;
        }
        if (verified) {
          const stored = localStorage.getItem("mirrorVerifiedUser");
          if (stored) userData = JSON.parse(stored);
          startQuestions();
          return;
        }
        if (payment === "cash" || payment === "bit") {
          const pending = localStorage.getItem("pendingPayment");
          if (pending) userData = JSON.parse(pending);
          /* stay on access-code view */
        } else {
          location.href = "/";
        }
      }

      /* helper to show section */
      function showSection(id) {
        document.querySelectorAll(".experience-section").forEach((sec) => {
          sec.classList.remove("active");
          setTimeout(() => sec.classList.add("hidden"), 300);
        });
        setTimeout(() => {
          document
            .querySelectorAll(".experience-section")
            .forEach((s) => s.classList.add("hidden"));
          const tgt = document.getElementById(id);
          tgt.classList.remove("hidden");
          setTimeout(() => tgt.classList.add("active"), 50);
        }, 300);
      }

      /* banner */
      function showError(msg) {
        errorMessage.textContent = msg;
        errorMessage.style.display = "block";
        codeInput.value = "";
      }

      /* verify access-code */
      async function verifyAccessCode() {
        const code = codeInput.value.trim();
        if (code.length !== 6) {
          return showError(translations[currentLanguage].invalidCode);
        }
        errorMessage.style.display = "none";
        try {
          const r = await fetch(`/api/send-access-code?code=${code}`);
          const j = await r.json();
          if (!j.success) throw new Error("invalid");
          userData = j.userData;
          localStorage.removeItem("pendingPayment");
          localStorage.setItem("mirrorVerifiedUser", JSON.stringify(userData));
          location.href = `/breathing.html?payment=cash&verified=true&lang=${currentLanguage}`;
        } catch (err) {
          console.error(err);
          showError(translations[currentLanguage].invalidCode);
        }
      }

      /* begin questions */
      function startQuestions() {
        showSection("questions");
        setTimeout(
          () =>
            document
              .querySelectorAll(".question-group")
              .forEach((q, i) =>
                setTimeout(() => q.classList.add("visible"), i * 200)
              ),
          300
        );
        setupQuestionInteractions();
      }

      /* interaction inside questions */
      function setupQuestionInteractions() {
        document.querySelectorAll(".yes-no-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            this.parentNode
              .querySelectorAll(".yes-no-btn")
              .forEach((b) => b.classList.remove("selected"));
            this.classList.add("selected");
            const hidden = this.parentNode.parentNode.querySelector(
              'input[name="hasDate"]'
            );
            hasDateSet = this.dataset.value;
            hidden.value = hasDateSet;
            if (hasDateSet === "yes") {
              dateContainer.style.display = "flex";
              dateContainer.querySelector("input").required = true;
            } else {
              dateContainer.style.display = "none";
              dateContainer.querySelector("input").required = false;
              dateContainer.querySelector("input").value = "";
            }
          });
        });

        reflectionForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          showSection("loading");
          const f = new FormData(reflectionForm);
          const payload = {
            dream: f.get("dream"),
            plan: f.get("plan"),
            hasDate: f.get("hasDate"),
            dreamDate: f.get("dreamDate"),
            relationship: f.get("relationship"),
            offering: f.get("offering"),
            userName: userData?.name || "Friend",
            userEmail: userData?.email || "",
            language: currentLanguage,
            isAdmin: isAdminMode,
          };
          try {
            const r = await fetch("/api/mirror-reflection", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            const j = await r.json();
            if (!j.success) throw new Error(j.error || "failed");
            reflectionContent.innerHTML = j.reflection;
            showSection("results");
          } catch (err) {
            console.error(err);
            reflectionContent.innerHTML = `<h2>${
              currentLanguage === "he" ? "×¨×’×¢ ×©×œ ×©×§×˜â€¦" : "A moment of silenceâ€¦"
            }</h2><p>${
              currentLanguage === "he"
                ? "×”×”×©×ª×§×¤×•×ª ×©×œ×š ××•×›× ×”. × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×¨×’×¢."
                : "Your reflection is being prepared. Please try again in a moment."
            }</p><p style="opacity:.7;font-style:italic;">${
              currentLanguage === "he"
                ? "×œ×¤×¢××™× ×”×××ª ×”×¢××•×§×” ×¦×¨×™×›×” ××¨×—×‘ ×›×“×™ ×œ×”×•×¤×™×¢."
                : "Sometimes the deepest truth needs space to emerge."
            }</p>`;
            showSection("results");
          }
        });
      }

      /* email reflection */
      function emailReflection() {
        if (!userData?.email) {
          const email = prompt(
            currentLanguage === "he"
              ? "×”×›× ×¡ ××™×™×œ ×œ×§×‘×œ×ª ×”×”×©×ª×§×¤×•×ª:"
              : "Enter your email to receive this reflection:"
          );
          if (!email) return;
          userData = { ...userData, email };
        }
        fetch("/api/send-mirror-email", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            email: userData.email,
            content: reflectionContent.innerHTML,
            userName: userData.name || "Friend",
            language: currentLanguage,
          }),
        })
          .then((r) => r.json())
          .then((d) => {
            alert(
              d.success
                ? currentLanguage === "he"
                  ? "×”×”×©×ª×§×¤×•×ª × ×©×œ×—×” ×œ××™×™×œ."
                  : "Reflection sent to your email."
                : currentLanguage === "he"
                ? "×”×™×™×ª×” ×‘×¢×™×” ×‘×©×œ×™×—×”."
                : "There was an issue sending."
            );
          })
          .catch(() =>
            alert(currentLanguage === "he" ? "×©×’×™××” ×‘×©×œ×™×—×”." : "Error sending.")
          );
      }
    </script>
  </body>
</html>
