<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <title>
      Gift Mirror of Truth Access | Self-Discovery for Someone You Care About
    </title>
    <style>
      /* Gift Flow - Perfect 3-Step Contained Experience */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        height: 100vh;
        overflow: hidden;
        background: linear-gradient(
          135deg,
          #0f0f23 0%,
          #1a1a2e 25%,
          #16213e 50%,
          #0f0f23 100%
        );
        color: #fff;
        font-family: Inter, -apple-system, BlinkMacSystemFont, sans-serif;
        position: fixed;
        width: 100vw;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* Cosmic background animation */
      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background: radial-gradient(
            circle at 20% 30%,
            rgba(59, 130, 246, 0.04) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 70%,
            rgba(16, 185, 129, 0.03) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 50% 50%,
            rgba(147, 51, 234, 0.02) 0%,
            transparent 50%
          );
        z-index: 1;
        animation: gentleShift 45s ease-in-out infinite;
      }

      @keyframes gentleShift {
        0%,
        100% {
          transform: scale(1) rotate(0deg);
          opacity: 0.7;
        }
        33% {
          transform: scale(1.05) rotate(120deg);
          opacity: 0.9;
        }
        66% {
          transform: scale(0.95) rotate(240deg);
          opacity: 0.6;
        }
      }

      /* Floating particles for ambiance */
      .floating-particles {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 2;
      }

      .particle {
        position: absolute;
        width: 3px;
        height: 3px;
        background: rgba(251, 191, 36, 0.4);
        border-radius: 50%;
        animation: gentleFloat 25s linear infinite;
      }

      .particle:nth-child(1) {
        left: 10%;
        animation-delay: 0s;
      }
      .particle:nth-child(2) {
        left: 25%;
        animation-delay: 5s;
        background: rgba(16, 185, 129, 0.3);
      }
      .particle:nth-child(3) {
        left: 50%;
        animation-delay: 10s;
        background: rgba(147, 51, 234, 0.3);
      }
      .particle:nth-child(4) {
        left: 75%;
        animation-delay: 15s;
        background: rgba(59, 130, 246, 0.3);
      }
      .particle:nth-child(5) {
        left: 90%;
        animation-delay: 20s;
      }

      @keyframes gentleFloat {
        0% {
          transform: translateY(100vh) scale(0.5);
          opacity: 0;
        }
        10% {
          opacity: 0.8;
        }
        90% {
          opacity: 0.3;
        }
        100% {
          transform: translateY(-10vh) scale(1);
          opacity: 0;
        }
      }

      /* Navigation */
      .back-link {
        position: fixed;
        top: clamp(1rem, 2vh, 1.5rem);
        left: clamp(1rem, 2vw, 1.5rem);
        z-index: 100;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: rgba(255, 255, 255, 0.7);
        text-decoration: none;
        padding: clamp(0.6rem, 1.2vh, 0.8rem) clamp(1rem, 1.8vw, 1.2rem);
        border-radius: 50px;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
        font-size: clamp(0.8rem, 1.6vw, 0.9rem);
        font-weight: 300;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        white-space: nowrap;
      }

      .back-link:hover {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.9);
        transform: translateY(-2px);
      }

      /* Progress indicator */
      .progress-container {
        position: fixed;
        top: clamp(1rem, 2vh, 1.5rem);
        right: clamp(1rem, 2vw, 1.5rem);
        z-index: 100;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: clamp(0.6rem, 1.2vh, 0.8rem) clamp(1rem, 1.8vw, 1.2rem);
        border-radius: 50px;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        font-size: clamp(0.8rem, 1.6vw, 0.9rem);
        font-weight: 300;
        color: rgba(255, 255, 255, 0.8);
      }

      .progress-steps {
        display: flex;
        gap: 0.3rem;
      }

      .progress-step {
        width: clamp(6px, 1.2vw, 8px);
        height: clamp(6px, 1.2vw, 8px);
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
      }

      .progress-step.active {
        background: rgba(251, 191, 36, 0.8);
        box-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
      }

      .progress-step.completed {
        background: rgba(16, 185, 129, 0.8);
        box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
      }

      /* Main container */
      .main-container {
        position: relative;
        z-index: 10;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: clamp(1rem, 2vh, 2rem) clamp(1rem, 3vw, 2rem);
        max-width: 100vw;
        margin: 0 auto;
      }

      /* Step container */
      .step-container {
        width: 100%;
        max-width: clamp(800px, 85vw, 1000px);
        display: none;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.6s ease;
      }

      .step-container.active {
        display: block;
        opacity: 1;
        transform: translateY(0);
      }

      /* Step 1 - What they'll receive */
      .step-1 {
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        gap: clamp(1.5rem, 3vh, 2.5rem);
      }

      .step-1 .header {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: clamp(0.8rem, 1.5vh, 1.2rem);
      }

      .gift-icon {
        font-size: clamp(3rem, 6vw, 4.5rem);
        animation: giftPulse 6s ease-in-out infinite;
        filter: drop-shadow(0 0 20px rgba(251, 191, 36, 0.4));
      }

      @keyframes giftPulse {
        0%,
        100% {
          transform: scale(1) rotate(0deg);
          opacity: 0.9;
        }
        50% {
          transform: scale(1.1) rotate(5deg);
          opacity: 1;
        }
      }

      .step-title {
        font-size: clamp(2.5rem, 5vw, 3.5rem);
        font-weight: 300;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.95) 0%,
          rgba(251, 191, 36, 0.8) 50%,
          rgba(255, 255, 255, 0.9) 100%
        );
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        letter-spacing: 0.5px;
        line-height: 1.1;
        margin-bottom: clamp(0.5rem, 1vh, 0.8rem);
      }

      .step-subtitle {
        font-size: clamp(1.2rem, 2.5vw, 1.6rem);
        opacity: 0.85;
        color: rgba(255, 255, 255, 0.8);
        line-height: 1.4;
        font-weight: 300;
        max-width: 600px;
      }

      /* Benefits grid */
      .benefits-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: clamp(1.2rem, 2.5vw, 2rem);
        width: 100%;
        max-width: 900px;
      }

      .benefit-card {
        background: rgba(255, 255, 255, 0.04);
        backdrop-filter: blur(40px) saturate(120%);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: clamp(16px, 3vw, 24px);
        padding: clamp(1.8rem, 3vh, 2.5rem);
        position: relative;
        overflow: hidden;
        transition: all 0.4s ease;
        text-align: left;
      }

      .benefit-card::before {
        content: "";
        position: absolute;
        inset: 1px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.08) 0%,
          rgba(251, 191, 36, 0.03) 30%,
          rgba(147, 51, 234, 0.02) 70%,
          rgba(255, 255, 255, 0.04) 100%
        );
        border-radius: clamp(15px, 3vw, 23px);
        pointer-events: none;
      }

      .benefit-card:hover {
        transform: translateY(-5px);
        border-color: rgba(255, 255, 255, 0.2);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
      }

      .benefit-icon {
        font-size: clamp(2rem, 4vw, 2.8rem);
        margin-bottom: clamp(1rem, 2vh, 1.5rem);
        display: block;
      }

      .benefit-title {
        font-size: clamp(1.2rem, 2.5vw, 1.5rem);
        font-weight: 500;
        margin-bottom: clamp(0.8rem, 1.5vh, 1rem);
        color: rgba(255, 255, 255, 0.95);
      }

      .benefit-description {
        font-size: clamp(0.95rem, 2vw, 1.1rem);
        line-height: 1.6;
        color: rgba(255, 255, 255, 0.75);
        margin: 0;
      }

      /* Step 2 - Fill details */
      .step-2 {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: clamp(2rem, 4vh, 3rem);
        height: 100%;
      }

      .step-2 .header {
        text-align: center;
        max-width: 600px;
      }

      .form-container {
        width: 100%;
        max-width: 650px;
        background: rgba(255, 255, 255, 0.04);
        backdrop-filter: blur(40px) saturate(120%);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: clamp(20px, 3vw, 28px);
        padding: clamp(2.5rem, 4vh, 3.5rem);
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
      }

      .form-container::before {
        content: "";
        position: absolute;
        inset: 1px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.08) 0%,
          rgba(251, 191, 36, 0.03) 30%,
          rgba(147, 51, 234, 0.02) 70%,
          rgba(255, 255, 255, 0.04) 100%
        );
        border-radius: clamp(19px, 3vw, 27px);
        pointer-events: none;
      }

      /* Form styling */
      .gift-form {
        display: flex;
        flex-direction: column;
        gap: clamp(1.5rem, 3vh, 2rem);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: clamp(1rem, 2vw, 1.5rem);
      }

      .form-group {
        position: relative;
        display: flex;
        flex-direction: column;
        gap: clamp(0.5rem, 1vh, 0.7rem);
      }

      .form-group.full-width {
        grid-column: 1 / -1;
      }

      .form-label {
        font-size: clamp(0.9rem, 1.8vw, 1rem);
        color: rgba(255, 255, 255, 0.8);
        font-weight: 400;
        letter-spacing: 0.3px;
      }

      .form-input {
        padding: clamp(1rem, 2vh, 1.2rem);
        background: rgba(255, 255, 255, 0.06);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: clamp(12px, 2.4vw, 16px);
        color: #fff;
        font-size: clamp(0.9rem, 1.8vw, 1rem);
        font-family: inherit;
        transition: all 0.3s ease;
        font-weight: 300;
        outline: none;
        -webkit-tap-highlight-color: transparent;
      }

      .form-input:focus {
        border-color: rgba(16, 185, 129, 0.4);
        background: rgba(255, 255, 255, 0.08);
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.15);
        transform: translateY(-1px);
      }

      .form-input::placeholder {
        color: rgba(255, 255, 255, 0.4);
        font-style: italic;
        font-weight: 300;
      }

      .form-textarea {
        min-height: clamp(90px, 15vh, 120px);
        resize: none;
        line-height: 1.6;
        font-family: inherit;
      }

      .char-counter {
        text-align: right;
        font-size: clamp(0.8rem, 1.6vw, 0.9rem);
        color: rgba(255, 255, 255, 0.5);
        margin-top: 0.3rem;
        transition: color 0.3s ease;
      }

      /* Tier selection */
      .tier-selection {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: clamp(16px, 3vw, 20px);
        padding: clamp(2rem, 3vh, 2.5rem);
        margin-top: clamp(1rem, 2vh, 1.5rem);
      }

      .section-title {
        font-size: clamp(1.2rem, 2.4vw, 1.5rem);
        font-weight: 500;
        margin-bottom: clamp(1.5rem, 3vh, 2rem);
        color: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        gap: 0.8rem;
        letter-spacing: 0.3px;
      }

      .section-title::before {
        content: "‚ú®";
        font-size: 0.9em;
        opacity: 0.8;
      }

      .tier-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: clamp(1.2rem, 2.5vw, 1.8rem);
        margin-bottom: clamp(2rem, 3vh, 2.5rem);
      }

      .tier-option {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: clamp(12px, 2.4vw, 16px);
        padding: clamp(1.5rem, 3vh, 2rem);
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .tier-option::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          135deg,
          rgba(16, 185, 129, 0.1) 0%,
          rgba(59, 130, 246, 0.08) 100%
        );
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .tier-option:hover {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
      }

      .tier-option:hover::before {
        opacity: 0.3;
      }

      .tier-option.selected {
        background: rgba(16, 185, 129, 0.1);
        border-color: rgba(16, 185, 129, 0.3);
        box-shadow: 0 0 25px rgba(16, 185, 129, 0.2);
      }

      .tier-option.selected::before {
        opacity: 1;
      }

      .tier-option.premium {
        position: relative;
        padding-top: clamp(2.2rem, 4vh, 2.8rem);
      }

      .premium-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        padding: clamp(0.4rem, 0.8vh, 0.5rem) clamp(0.8rem, 1.5vw, 1rem);
        border-radius: 10px;
        font-size: clamp(0.7rem, 1.4vw, 0.8rem);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
      }

      .tier-name {
        font-size: clamp(1.2rem, 2.4vw, 1.5rem);
        font-weight: 500;
        margin-bottom: clamp(0.8rem, 1.5vh, 1rem);
        color: rgba(255, 255, 255, 0.95);
      }

      .tier-description {
        font-size: clamp(0.85rem, 1.7vw, 1rem);
        color: rgba(255, 255, 255, 0.7);
        line-height: 1.5;
      }

      /* Duration selection */
      .duration-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: clamp(1rem, 2vw, 1.3rem);
      }

      .duration-option {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: clamp(10px, 2vw, 14px);
        padding: clamp(1.2rem, 2.5vh, 1.6rem);
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .duration-option::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          135deg,
          rgba(251, 191, 36, 0.1) 0%,
          rgba(147, 51, 234, 0.08) 100%
        );
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .duration-option:hover {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
      }

      .duration-option:hover::before {
        opacity: 0.3;
      }

      .duration-option.selected {
        background: rgba(251, 191, 36, 0.1);
        border-color: rgba(251, 191, 36, 0.3);
        box-shadow: 0 0 20px rgba(251, 191, 36, 0.2);
      }

      .duration-option.selected::before {
        opacity: 1;
      }

      .duration-name {
        font-size: clamp(0.9rem, 1.8vw, 1rem);
        font-weight: 500;
        margin-bottom: clamp(0.5rem, 1vh, 0.7rem);
        color: rgba(255, 255, 255, 0.9);
      }

      .duration-price {
        font-size: clamp(1.1rem, 2.2vw, 1.3rem);
        font-weight: 600;
        color: #10b981;
      }

      /* Step 3 - Payment */
      .step-3 {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: clamp(2rem, 4vh, 3rem);
        height: 100%;
        text-align: center;
      }

      .step-3 .header {
        max-width: 600px;
      }

      .payment-container {
        width: 100%;
        max-width: 500px;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(40px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: clamp(20px, 3vw, 28px);
        padding: clamp(2.5rem, 4vh, 3.5rem);
        position: relative;
        overflow: hidden;
      }

      .payment-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(16, 185, 129, 0.8) 50%,
          transparent 100%
        );
      }

      .total-amount {
        font-size: clamp(2.5rem, 5vw, 3.5rem);
        font-weight: 600;
        margin-bottom: clamp(0.5rem, 1vh, 0.8rem);
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
      }

      .total-description {
        font-size: clamp(1rem, 2vw, 1.2rem);
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: clamp(2rem, 3vh, 2.5rem);
      }

      .gift-summary {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: clamp(12px, 2.4vw, 16px);
        padding: clamp(1.5rem, 3vh, 2rem);
        margin-bottom: clamp(2rem, 3vh, 2.5rem);
        text-align: left;
      }

      .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: clamp(0.5rem, 1vh, 0.7rem) 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .summary-row:last-child {
        border-bottom: none;
        font-weight: 500;
        font-size: clamp(1rem, 2vw, 1.1rem);
      }

      .summary-label {
        color: rgba(255, 255, 255, 0.7);
        font-size: clamp(0.9rem, 1.8vw, 1rem);
      }

      .summary-value {
        color: rgba(255, 255, 255, 0.9);
        font-size: clamp(0.9rem, 1.8vw, 1rem);
      }

      #paypal-button-container {
        min-height: clamp(55px, 10vh, 65px);
        border-radius: clamp(12px, 2.4vw, 16px);
        overflow: hidden;
        margin: clamp(1.5rem, 3vh, 2rem) 0;
      }

      .paypal-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: clamp(1rem, 2vw, 1.3rem);
        padding: clamp(1.5rem, 3vh, 2rem);
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-radius: clamp(12px, 2.4vw, 16px);
        color: #93c5fd;
        font-size: clamp(0.9rem, 1.8vw, 1rem);
      }

      .loading-spinner {
        width: clamp(20px, 4vw, 24px);
        height: clamp(20px, 4vw, 24px);
        border: 2px solid rgba(147, 197, 253, 0.3);
        border-radius: 50%;
        border-top-color: #93c5fd;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Navigation buttons */
      .nav-buttons {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        max-width: 500px;
        margin-top: clamp(2rem, 4vh, 3rem);
        gap: clamp(1rem, 2vw, 1.5rem);
      }

      .nav-button {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        padding: clamp(0.8rem, 1.6vh, 1rem) clamp(1.5rem, 3vw, 2rem);
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.08) 0%,
          rgba(255, 255, 255, 0.04) 100%
        );
        backdrop-filter: blur(25px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: clamp(12px, 2.4vw, 16px);
        color: rgba(255, 255, 255, 0.9);
        font-size: clamp(0.9rem, 1.8vw, 1rem);
        font-weight: 400;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        white-space: nowrap;
        flex: 1;
        justify-content: center;
      }

      .nav-button:hover {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.12) 0%,
          rgba(255, 255, 255, 0.06) 100%
        );
        border-color: rgba(255, 255, 255, 0.25);
        transform: translateY(-2px);
      }

      .nav-button.primary {
        background: linear-gradient(
          135deg,
          rgba(16, 185, 129, 0.12) 0%,
          rgba(5, 150, 105, 0.08) 100%
        );
        border-color: rgba(16, 185, 129, 0.25);
        color: rgba(255, 255, 255, 0.95);
      }

      .nav-button.primary:hover {
        background: linear-gradient(
          135deg,
          rgba(16, 185, 129, 0.18) 0%,
          rgba(5, 150, 105, 0.12) 100%
        );
        border-color: rgba(16, 185, 129, 0.35);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.15);
      }

      .nav-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .nav-button:disabled:hover {
        transform: none;
      }

      /* Messages */
      .message {
        padding: clamp(0.8rem, 1.6vh, 1rem);
        border-radius: clamp(10px, 2vw, 14px);
        font-size: clamp(0.9rem, 1.8vw, 1rem);
        text-align: center;
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s ease;
        font-weight: 300;
        margin-bottom: clamp(1rem, 2vh, 1.3rem);
        max-width: 600px;
        width: 100%;
      }

      .message.show {
        opacity: 1;
        transform: translateY(0);
      }

      .message.error {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.2);
        color: rgba(252, 165, 165, 0.9);
      }

      .message.success {
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.2);
        color: rgba(110, 231, 183, 0.9);
      }

      .message.info {
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.2);
        color: rgba(147, 197, 253, 0.9);
      }

      /* Mobile responsive */
      @media (max-width: 768px) {
        .benefits-grid {
          grid-template-columns: 1fr;
          gap: clamp(1rem, 2vh, 1.5rem);
        }

        .form-row {
          grid-template-columns: 1fr;
          gap: clamp(0.8rem, 1.5vh, 1rem);
        }

        .tier-grid {
          grid-template-columns: 1fr;
        }

        .duration-grid {
          grid-template-columns: 1fr;
        }

        .nav-buttons {
          flex-direction: column;
          gap: clamp(0.8rem, 1.5vh, 1rem);
        }

        .nav-button {
          width: 100%;
        }
      }

      @media (max-width: 480px) {
        .main-container {
          padding: clamp(0.5rem, 1vh, 1rem) clamp(0.8rem, 1.5vw, 1.2rem);
        }

        .form-container,
        .payment-container {
          padding: clamp(1.8rem, 3vh, 2.5rem) clamp(1.5rem, 3vw, 2rem);
        }

        .tier-option,
        .duration-option {
          padding: clamp(1rem, 2vh, 1.3rem);
        }
      }

      /* Height-constrained screens */
      @media (max-height: 700px) {
        .main-container {
          padding: clamp(0.5rem, 1vh, 1rem) clamp(1rem, 2vw, 1.5rem);
        }

        .step-container {
          gap: clamp(1rem, 2vh, 1.5rem);
        }

        .benefits-grid {
          gap: clamp(0.8rem, 1.5vh, 1.2rem);
        }

        .benefit-card {
          padding: clamp(1.2rem, 2.5vh, 1.8rem);
        }
      }

      @media (max-height: 600px) {
        .gift-icon {
          font-size: clamp(2rem, 4vw, 2.8rem);
        }

        .step-title {
          font-size: clamp(2rem, 4vw, 2.8rem);
        }

        .benefits-grid {
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: clamp(0.8rem, 1.5vh, 1rem);
        }

        .benefit-card {
          padding: clamp(1rem, 2vh, 1.5rem);
        }

        .form-container,
        .payment-container {
          padding: clamp(1.5rem, 3vh, 2rem);
        }
      }

      /* Landscape mobile */
      @media (max-height: 500px) and (orientation: landscape) {
        .main-container {
          padding: clamp(0.5rem, 1vh, 1rem);
          gap: clamp(0.5rem, 1vh, 1rem);
        }

        .step-title {
          font-size: clamp(1.8rem, 3.5vw, 2.2rem);
        }

        .step-subtitle {
          font-size: clamp(1rem, 2vw, 1.2rem);
        }

        .benefits-grid {
          grid-template-columns: repeat(3, 1fr);
          gap: clamp(0.8rem, 1.5vw, 1rem);
        }

        .benefit-card {
          padding: clamp(0.8rem, 1.5vh, 1.2rem);
        }

        .benefit-icon {
          font-size: clamp(1.5rem, 3vw, 2rem);
          margin-bottom: clamp(0.5rem, 1vh, 0.8rem);
        }

        .benefit-title {
          font-size: clamp(1rem, 2vw, 1.2rem);
          margin-bottom: clamp(0.5rem, 1vh, 0.7rem);
        }

        .benefit-description {
          font-size: clamp(0.8rem, 1.5vw, 0.95rem);
        }

        .nav-buttons {
          margin-top: clamp(1rem, 2vh, 1.5rem);
        }
      }

      /* Accessibility */
      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }

      /* Focus styles for accessibility */
      .tier-option:focus-visible,
      .duration-option:focus-visible,
      .form-input:focus-visible,
      .nav-button:focus-visible,
      .back-link:focus-visible {
        outline: 2px solid rgba(16, 185, 129, 0.6);
        outline-offset: 2px;
      }

      /* Remove default focus outlines */
      * {
        outline: none !important;
        -webkit-tap-highlight-color: transparent;
      }
    </style>
  </head>

  <body>
    <!-- Floating particles for ambiance -->
    <div class="floating-particles">
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
    </div>

    <!-- Navigation -->
    <a href="/" class="back-link">
      <span>‚Üê</span>
      <span>Return to Portal</span>
    </a>

    <!-- Progress indicator -->
    <div class="progress-container">
      <div class="progress-steps">
        <div class="progress-step active" id="step1Progress"></div>
        <div class="progress-step" id="step2Progress"></div>
        <div class="progress-step" id="step3Progress"></div>
      </div>
      <span id="progressText">1 of 3</span>
    </div>

    <!-- Main container -->
    <div class="main-container">
      <!-- Messages -->
      <div class="message error" id="errorMessage" style="display: none"></div>
      <div
        class="message success"
        id="successMessage"
        style="display: none"
      ></div>
      <div class="message info" id="infoMessage" style="display: none"></div>

      <!-- Step 1: What they'll receive -->
      <div class="step-container step-1 active" id="step1">
        <div class="header">
          <div class="gift-icon">üéÅ</div>
          <h1 class="step-title">What they'll receive</h1>
          <p class="step-subtitle">
            A complete self-discovery experience that arrives instantly in their
            inbox
          </p>
        </div>

        <div class="benefits-grid">
          <div class="benefit-card">
            <div class="benefit-icon">üìß</div>
            <h3 class="benefit-title">Beautiful Welcome Invitation</h3>
            <p class="benefit-description">
              A personalized email invitation with your message, explaining this
              gift of self-discovery and how to begin their journey.
            </p>
          </div>

          <div class="benefit-card">
            <div class="benefit-icon">üö™</div>
            <h3 class="benefit-title">Instant Platform Access</h3>
            <p class="benefit-description">
              Immediate access to their chosen subscription tier with no setup
              required. They can start reflecting within minutes of receiving
              your gift.
            </p>
          </div>

          <div class="benefit-card">
            <div class="benefit-icon">ü§ñ</div>
            <h3 class="benefit-title">AI-Powered Pattern Recognition</h3>
            <p class="benefit-description">
              Advanced AI that notices patterns in their responses they might
              miss themselves, revealing insights about who they truly are.
            </p>
          </div>

          <div class="benefit-card">
            <div class="benefit-icon">üìä</div>
            <h3 class="benefit-title">Personal Growth Dashboard</h3>
            <p class="benefit-description">
              A beautiful interface to track their reflection journey, save
              meaningful insights, and watch their self-awareness evolve over
              time.
            </p>
          </div>

          <div class="benefit-card">
            <div class="benefit-icon">üå±</div>
            <h3 class="benefit-title">Evolution Reports</h3>
            <p class="benefit-description">
              Detailed analysis of how their language, confidence, and
              self-understanding develops across multiple reflections (Premium
              tier only).
            </p>
          </div>

          <div class="benefit-card">
            <div class="benefit-icon">‚è∞</div>
            <h3 class="benefit-title">Extended Journey</h3>
            <p class="benefit-description">
              Full access for the duration you choose - whether one month of
              exploration or a full year of self-discovery and growth.
            </p>
          </div>
        </div>

        <div class="nav-buttons">
          <div></div>
          <button class="nav-button primary" onclick="nextStep()">
            <span>Choose Their Experience</span>
            <span>‚Üí</span>
          </button>
        </div>
      </div>

      <!-- Step 2: Fill details -->
      <div class="step-container step-2" id="step2">
        <div class="header">
          <div class="gift-icon">‚ú®</div>
          <h1 class="step-title">Create Their Gift</h1>
          <p class="step-subtitle">
            Personalize their experience and choose the perfect level of access
          </p>
        </div>

        <div class="form-container">
          <form id="giftForm" class="gift-form">
            <!-- Gift details -->
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Your name</label>
                <input
                  type="text"
                  id="giverName"
                  class="form-input"
                  placeholder="Your full name"
                  required
                />
              </div>
              <div class="form-group">
                <label class="form-label">Your email</label>
                <input
                  type="email"
                  id="giverEmail"
                  class="form-input"
                  placeholder="your@email.com"
                  required
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Recipient's name</label>
                <input
                  type="text"
                  id="recipientName"
                  class="form-input"
                  placeholder="Who will receive this gift?"
                  required
                />
              </div>
              <div class="form-group">
                <label class="form-label">Recipient's email</label>
                <input
                  type="email"
                  id="recipientEmail"
                  class="form-input"
                  placeholder="their@email.com"
                  required
                />
              </div>
            </div>

            <div class="form-group full-width">
              <label class="form-label">Personal message (optional)</label>
              <textarea
                id="personalMessage"
                class="form-input form-textarea"
                placeholder="Why are you sharing this journey of self-discovery with them?"
                maxlength="200"
              ></textarea>
              <div class="char-counter">
                <span id="charCount">0</span>/200 characters
              </div>
            </div>
          </form>

          <!-- Tier and duration selection -->
          <div class="tier-selection">
            <h3 class="section-title">Choose access level</h3>
            <div class="tier-grid">
              <div class="tier-option" data-tier="essential">
                <div class="tier-name">Essential</div>
                <div class="tier-description">
                  5 reflections/month<br />
                  Pattern insights<br />
                  Growth tracking
                </div>
              </div>
              <div class="tier-option premium" data-tier="premium">
                <div class="premium-badge">Most Popular</div>
                <div class="tier-name">Premium</div>
                <div class="tier-description">
                  10 reflections/month<br />
                  Advanced AI analysis<br />
                  Deep insights
                </div>
              </div>
            </div>

            <h3 class="section-title">Choose duration</h3>
            <div class="duration-grid">
              <div class="duration-option" data-duration="1mo">
                <div class="duration-name">1 Month</div>
                <div class="duration-price" id="price1mo">$4.99</div>
              </div>
              <div class="duration-option" data-duration="3mo">
                <div class="duration-name">3 Months</div>
                <div class="duration-price" id="price3mo">$14.97</div>
              </div>
              <div class="duration-option" data-duration="1yr">
                <div class="duration-name">1 Year</div>
                <div class="duration-price" id="price1yr">$49.99</div>
              </div>
            </div>
          </div>
        </div>

        <div class="nav-buttons">
          <button class="nav-button" onclick="previousStep()">
            <span>‚Üê</span>
            <span>Back</span>
          </button>
          <button
            class="nav-button primary"
            id="reviewButton"
            onclick="nextStep()"
            disabled
          >
            <span>Review & Pay</span>
            <span>‚Üí</span>
          </button>
        </div>
      </div>

      <!-- Step 3: Payment -->
      <div class="step-container step-3" id="step3">
        <div class="header">
          <div class="gift-icon">üíù</div>
          <h1 class="step-title">Complete Your Gift</h1>
          <p class="step-subtitle">
            Review your choices and send this beautiful experience
          </p>
        </div>

        <div class="payment-container">
          <div class="total-amount" id="totalAmount">$4.99</div>
          <div class="total-description" id="totalDescription">
            Essential ‚Ä¢ 1 Month
          </div>

          <div class="gift-summary" id="giftSummary">
            <div class="summary-row">
              <span class="summary-label">From:</span>
              <span class="summary-value" id="summaryGiver">-</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">To:</span>
              <span class="summary-value" id="summaryRecipient">-</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Access Level:</span>
              <span class="summary-value" id="summaryTier">-</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Duration:</span>
              <span class="summary-value" id="summaryDuration">-</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Total:</span>
              <span class="summary-value" id="summaryTotal">-</span>
            </div>
          </div>

          <div class="paypal-loading" id="paypalLoading">
            <div class="loading-spinner"></div>
            <span>Loading payment options...</span>
          </div>

          <div id="paypal-button-container"></div>
        </div>

        <div class="nav-buttons">
          <button class="nav-button" onclick="previousStep()">
            <span>‚Üê</span>
            <span>Back to Details</span>
          </button>
          <div></div>
        </div>
      </div>
    </div>

    <script>
      // Gift Flow - Perfect 3-Step Experience
      let currentStep = 1;
      let paypalConfig = null;
      let paypalInitialized = false;
      let selectedTier = "essential";
      let selectedDuration = "1mo";
      let currentAmount = "4.99";
      let giftPricing = {};
      let isProcessing = false;

      // Initialize the gift experience
      document.addEventListener("DOMContentLoaded", function () {
        initializeGiftFlow();
      });

      async function initializeGiftFlow() {
        setupEventListeners();
        await loadGiftPricing();
        await loadPayPalConfiguration();
        initializeSelections();
        setupFormValidation();
        console.log("üéÅ Perfect 3-step gift flow initialized");
      }

      function setupEventListeners() {
        // Form validation
        ["giverName", "giverEmail", "recipientName", "recipientEmail"].forEach(
          (id) => {
            const input = document.getElementById(id);
            if (input) {
              input.addEventListener("input", validateForm);
              input.addEventListener("blur", validateField);
            }
          }
        );

        // Personal message counter
        const messageInput = document.getElementById("personalMessage");
        const charCount = document.getElementById("charCount");

        if (messageInput && charCount) {
          messageInput.addEventListener("input", function () {
            const length = this.value.length;
            charCount.textContent = length;

            const counter = document.querySelector(".char-counter");
            if (length > 160) {
              counter.style.color = "#ef4444";
            } else if (length > 120) {
              counter.style.color = "#f59e0b";
            } else {
              counter.style.color = "rgba(255, 255, 255, 0.5)";
            }
          });
        }

        // Name formatting
        ["giverName", "recipientName"].forEach((id) => {
          const input = document.getElementById(id);
          if (input) {
            input.addEventListener("blur", function () {
              this.value = this.value.replace(/\b\w/g, (l) => l.toUpperCase());
            });
          }
        });

        // Tier selection
        document.querySelectorAll(".tier-option").forEach((option) => {
          option.addEventListener("click", function () {
            selectTier(this.dataset.tier);
          });
        });

        // Duration selection
        document.querySelectorAll(".duration-option").forEach((option) => {
          option.addEventListener("click", function () {
            selectDuration(this.dataset.duration);
          });
        });

        // Keyboard navigation
        document.addEventListener("keydown", function (e) {
          if (e.key === "ArrowRight" || (e.key === "Enter" && e.ctrlKey)) {
            if (currentStep < 3) nextStep();
          } else if (e.key === "ArrowLeft") {
            if (currentStep > 1) previousStep();
          } else if (e.key === "Escape") {
            window.location.href = "/";
          }
        });
      }

      async function loadGiftPricing() {
        try {
          const response = await fetch("/api/subscriptions?action=get-pricing");
          if (!response.ok) throw new Error(`HTTP ${response.status}`);

          const result = await response.json();
          if (!result.success)
            throw new Error(result.error || "Failed to load pricing");

          giftPricing = result.pricing.gifts;
          updatePricingDisplay();
        } catch (error) {
          console.error("Pricing error:", error);
          // Fallback pricing
          giftPricing = {
            essential: { "1mo": 4.99, "3mo": 14.97, "1yr": 49.99 },
            premium: { "1mo": 9.99, "3mo": 29.97, "1yr": 99.99 },
          };
          updatePricingDisplay();
        }
      }

      function updatePricingDisplay() {
        const elements = {
          price1mo: document.getElementById("price1mo"),
          price3mo: document.getElementById("price3mo"),
          price1yr: document.getElementById("price1yr"),
        };

        if (elements.price1mo)
          elements.price1mo.textContent = `$${giftPricing[selectedTier]["1mo"]}`;
        if (elements.price3mo)
          elements.price3mo.textContent = `$${giftPricing[selectedTier]["3mo"]}`;
        if (elements.price1yr)
          elements.price1yr.textContent = `$${giftPricing[selectedTier]["1yr"]}`;

        currentAmount = giftPricing[selectedTier][selectedDuration].toString();
        updateTotalDisplay();
      }

      function initializeSelections() {
        selectTier("essential");
        selectDuration("1mo");
      }

      function selectTier(tier) {
        selectedTier = tier;

        // Update tier selection UI
        document.querySelectorAll(".tier-option").forEach((option) => {
          option.classList.remove("selected");
        });
        const selectedOption = document.querySelector(`[data-tier="${tier}"]`);
        if (selectedOption) {
          selectedOption.classList.add("selected");
        }

        updatePricingDisplay();
        validateForm();
        createSelectionEffect(selectedOption);
      }

      function selectDuration(duration) {
        selectedDuration = duration;

        // Update duration selection UI
        document.querySelectorAll(".duration-option").forEach((option) => {
          option.classList.remove("selected");
        });
        const selectedOption = document.querySelector(
          `[data-duration="${duration}"]`
        );
        if (selectedOption) {
          selectedOption.classList.add("selected");
        }

        currentAmount = giftPricing[selectedTier][duration].toString();
        updateTotalDisplay();
        validateForm();
        createSelectionEffect(selectedOption);
      }

      function updateTotalDisplay() {
        const tierName =
          selectedTier.charAt(0).toUpperCase() + selectedTier.slice(1);
        const durationText =
          selectedDuration === "1mo"
            ? "1 Month"
            : selectedDuration === "3mo"
            ? "3 Months"
            : "1 Year";

        const totalAmount = document.getElementById("totalAmount");
        const totalDescription = document.getElementById("totalDescription");

        if (totalAmount) totalAmount.textContent = `$${currentAmount}`;
        if (totalDescription)
          totalDescription.textContent = `${tierName} ‚Ä¢ ${durationText}`;
      }

      async function loadPayPalConfiguration() {
        try {
          const response = await fetch("/api/payment?action=config");
          if (!response.ok) throw new Error(`HTTP ${response.status}`);

          const result = await response.json();
          if (!result.success)
            throw new Error(result.error || "PayPal configuration failed");

          paypalConfig = result.config;
        } catch (error) {
          console.error("PayPal configuration error:", error);
          showMessage(
            "Payment system initialization failed. Please refresh the page.",
            "error"
          );
        }
      }

      function validateForm() {
        const giverName =
          document.getElementById("giverName")?.value?.trim() || "";
        const giverEmail =
          document.getElementById("giverEmail")?.value?.trim() || "";
        const recipientName =
          document.getElementById("recipientName")?.value?.trim() || "";
        const recipientEmail =
          document.getElementById("recipientEmail")?.value?.trim() || "";

        const isValid =
          giverName &&
          validateEmail(giverEmail) &&
          recipientName &&
          validateEmail(recipientEmail) &&
          selectedTier &&
          selectedDuration;

        const reviewButton = document.getElementById("reviewButton");
        if (reviewButton) {
          reviewButton.disabled = !isValid;
        }

        return isValid;
      }

      function validateField(event) {
        const field = event.target;
        const value = field.value.trim();

        if (field.type === "email") {
          if (value && !validateEmail(value)) {
            field.style.borderColor = "rgba(239, 68, 68, 0.4)";
          } else {
            field.style.borderColor = "";
          }
        } else if (field.type === "text") {
          if (value && value.length < 2) {
            field.style.borderColor = "rgba(245, 158, 11, 0.4)";
          } else {
            field.style.borderColor = "";
          }
        }
      }

      function validateEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      }

      function setupFormValidation() {
        validateForm();
      }

      // Step navigation
      function nextStep() {
        if (currentStep < 3) {
          if (currentStep === 2 && !validateForm()) {
            showMessage(
              "Please fill in all required fields with valid information.",
              "error"
            );
            return;
          }

          hideMessages();
          updateStep(currentStep + 1);

          if (currentStep === 3) {
            updateSummary();
            initializePayPal();
          }
        }
      }

      function previousStep() {
        if (currentStep > 1) {
          hideMessages();
          updateStep(currentStep - 1);
        }
      }

      function updateStep(step) {
        // Hide current step
        const currentStepEl = document.getElementById(`step${currentStep}`);
        if (currentStepEl) {
          currentStepEl.classList.remove("active");
        }

        // Update progress
        updateProgress(currentStep, false);

        currentStep = step;

        // Show new step
        const newStepEl = document.getElementById(`step${currentStep}`);
        if (newStepEl) {
          setTimeout(() => {
            newStepEl.classList.add("active");
          }, 300);
        }

        // Update progress
        updateProgress(currentStep, true);

        // Update progress text
        const progressText = document.getElementById("progressText");
        if (progressText) {
          progressText.textContent = `${currentStep} of 3`;
        }
      }

      function updateProgress(step, active) {
        const progressStep = document.getElementById(`step${step}Progress`);
        if (!progressStep) return;

        if (active) {
          progressStep.classList.add("active");
          progressStep.classList.remove("completed");
        } else {
          progressStep.classList.remove("active");
          if (step < currentStep) {
            progressStep.classList.add("completed");
          }
        }
      }

      function updateSummary() {
        const giverName =
          document.getElementById("giverName")?.value?.trim() || "";
        const recipientName =
          document.getElementById("recipientName")?.value?.trim() || "";
        const tierName =
          selectedTier.charAt(0).toUpperCase() + selectedTier.slice(1);
        const durationText =
          selectedDuration === "1mo"
            ? "1 Month"
            : selectedDuration === "3mo"
            ? "3 Months"
            : "1 Year";

        // Update summary elements
        const elements = {
          summaryGiver: document.getElementById("summaryGiver"),
          summaryRecipient: document.getElementById("summaryRecipient"),
          summaryTier: document.getElementById("summaryTier"),
          summaryDuration: document.getElementById("summaryDuration"),
          summaryTotal: document.getElementById("summaryTotal"),
        };

        if (elements.summaryGiver)
          elements.summaryGiver.textContent = giverName;
        if (elements.summaryRecipient)
          elements.summaryRecipient.textContent = recipientName;
        if (elements.summaryTier) elements.summaryTier.textContent = tierName;
        if (elements.summaryDuration)
          elements.summaryDuration.textContent = durationText;
        if (elements.summaryTotal)
          elements.summaryTotal.textContent = `$${currentAmount}`;
      }

      function initializePayPal() {
        if (!window.paypal || !window.paypal.Buttons) {
          loadPayPalSDK()
            .then(() => {
              setupPayPalButtons();
            })
            .catch((error) => {
              console.error("PayPal SDK load error:", error);
              showMessage(
                "Payment system not available. Please refresh the page.",
                "error"
              );
            });
        } else {
          setupPayPalButtons();
        }
      }

      function loadPayPalSDK() {
        return new Promise((resolve, reject) => {
          if (window.paypal && window.paypal.Buttons) {
            hidePayPalLoading();
            resolve();
            return;
          }

          const script = document.createElement("script");
          script.src = `https://www.paypal.com/sdk/js?client-id=${paypalConfig.clientId}&currency=${paypalConfig.currency}&intent=capture`;

          const timeout = setTimeout(() => {
            reject(new Error("PayPal loading timeout"));
          }, 15000);

          script.onload = () => {
            clearTimeout(timeout);
            setTimeout(() => {
              if (window.paypal && window.paypal.Buttons) {
                hidePayPalLoading();
                resolve();
              } else {
                reject(new Error("PayPal loaded but not available"));
              }
            }, 100);
          };

          script.onerror = () => {
            clearTimeout(timeout);
            reject(new Error("Failed to load PayPal"));
          };

          document.head.appendChild(script);
        });
      }

      function hidePayPalLoading() {
        const loading = document.getElementById("paypalLoading");
        if (loading) {
          loading.style.display = "none";
        }
      }

      function setupPayPalButtons() {
        if (paypalInitialized) return;

        try {
          window.paypal
            .Buttons({
              style: {
                color: "gold",
                shape: "rect",
                label: "pay",
                height: 55,
                tagline: false,
              },

              createOrder: function (data, actions) {
                const giverName = document
                  .getElementById("giverName")
                  .value.trim();
                const giverEmail = document
                  .getElementById("giverEmail")
                  .value.trim();
                const tierName =
                  selectedTier.charAt(0).toUpperCase() + selectedTier.slice(1);
                const durationText =
                  selectedDuration === "1mo"
                    ? "1 Month"
                    : selectedDuration === "3mo"
                    ? "3 Months"
                    : "1 Year";

                const orderData = {
                  purchase_units: [
                    {
                      amount: {
                        value: currentAmount,
                        currency_code: paypalConfig.currency,
                      },
                      description: `Mirror of Truth - ${tierName} Gift (${durationText})`,
                    },
                  ],
                };

                if (giverEmail && validateEmail(giverEmail)) {
                  orderData.payer = {
                    email_address: giverEmail,
                    name: {
                      given_name: giverName.split(" ")[0] || giverName,
                      surname: giverName.split(" ").slice(1).join(" ") || "",
                    },
                  };
                }

                return actions.order.create(orderData);
              },

              onApprove: function (data, actions) {
                return actions.order.capture().then(function (details) {
                  handleGiftCompletion(details);
                });
              },

              onError: function (err) {
                console.error("PayPal error:", err);
                showMessage("Payment error. Please try again.", "error");
              },

              onCancel: function (data) {
                // Payment cancelled, user can try again
              },
            })
            .render("#paypal-button-container")
            .then(() => {
              paypalInitialized = true;
            })
            .catch((error) => {
              console.error("PayPal render error:", error);
              showMessage(
                "Payment system initialization failed. Please refresh the page.",
                "error"
              );
            });
        } catch (error) {
          console.error("PayPal initialization error:", error);
          showMessage(
            "Payment system error. Please refresh the page.",
            "error"
          );
        }
      }

      async function handleGiftCompletion(paymentDetails) {
        try {
          const giftData = {
            giverName: document.getElementById("giverName").value.trim(),
            giverEmail: document.getElementById("giverEmail").value.trim(),
            recipientName: document
              .getElementById("recipientName")
              .value.trim(),
            recipientEmail: document
              .getElementById("recipientEmail")
              .value.trim(),
            personalMessage: document
              .getElementById("personalMessage")
              .value.trim(),
            subscriptionTier: selectedTier,
            subscriptionDuration: selectedDuration,
            amount: parseFloat(currentAmount),
            paymentMethod: "paypal",
            paymentId: paymentDetails.id,
          };

          const response = await fetch("/api/subscriptions", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "gift-subscription",
              ...giftData,
            }),
          });

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.error || "Failed to create gift");
          }

          const tierName =
            selectedTier.charAt(0).toUpperCase() + selectedTier.slice(1);
          const durationText =
            selectedDuration === "1mo"
              ? "one month"
              : selectedDuration === "3mo"
              ? "three months"
              : "one year";

          showMessage(
            `üéÅ Gift successfully created! ${giftData.recipientName} will receive ${durationText} of ${tierName} access.`,
            "success"
          );

          setTimeout(() => {
            window.location.href = "/";
          }, 3000);
        } catch (error) {
          console.error("Gift creation error:", error);
          showMessage(
            "Gift was paid for but invitation creation failed. Please contact support.",
            "error"
          );
          setTimeout(() => {
            window.location.href = "/";
          }, 5000);
        }
      }

      function showMessage(message, type) {
        const messageDiv = document.getElementById(`${type}Message`);
        if (!messageDiv) return;

        // Hide all messages first
        hideMessages();

        messageDiv.textContent = message;
        messageDiv.style.display = "block";

        requestAnimationFrame(() => {
          messageDiv.classList.add("show");
        });

        if (type === "error") {
          setTimeout(hideMessages, 6000);
        } else if (type === "success") {
          setTimeout(hideMessages, 8000);
        }
      }

      function hideMessages() {
        ["errorMessage", "successMessage", "infoMessage"].forEach((id) => {
          const div = document.getElementById(id);
          if (div) {
            div.classList.remove("show");
            setTimeout(() => (div.style.display = "none"), 300);
          }
        });
      }

      function createSelectionEffect(element) {
        if (!element) return;

        const rect = element.getBoundingClientRect();
        for (let i = 0; i < 4; i++) {
          setTimeout(() => {
            const effect = document.createElement("div");
            const offsetX = (Math.random() - 0.5) * 80;
            const offsetY = (Math.random() - 0.5) * 80;

            effect.style.cssText = `
              position: fixed;
              left: ${rect.left + rect.width / 2 + offsetX}px;
              top: ${rect.top + rect.height / 2 + offsetY}px;
              width: 4px;
              height: 4px;
              background: radial-gradient(circle, rgba(16, 185, 129, 1) 0%, rgba(251, 191, 36, 0.8) 60%, transparent 90%);
              border-radius: 50%;
              pointer-events: none;
              z-index: 1000;
              animation: selectionEffect 2.5s ease-out forwards;
            `;

            document.body.appendChild(effect);
            setTimeout(() => effect.remove(), 2500);
          }, i * 60);
        }
      }

      // Add selection effect animation
      const effectStyle = document.createElement("style");
      effectStyle.textContent = `
        @keyframes selectionEffect {
          0% { opacity: 0; transform: scale(0) rotate(0deg); }
          50% { opacity: 1; transform: scale(1.5) rotate(180deg); }
          100% { opacity: 0; transform: scale(0) rotate(360deg); }
        }
      `;
      document.head.appendChild(effectStyle);

      // Debug (development only)
      if (window.location.hostname === "localhost") {
        window.giftDebug = {
          currentStep: () => currentStep,
          goToStep: (step) => updateStep(step),
          selectedTier: () => selectedTier,
          selectedDuration: () => selectedDuration,
          currentAmount: () => currentAmount,
          pricing: () => giftPricing,
          validateForm: validateForm,
          testMessage: (msg, type) => showMessage(msg, type),
        };
      }
    </script>
  </body>
</html>
